---
title: "Crane_trachea conservative data set"
author: "Chauncey Gadek and Trinity Casaus" 
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  html_document:
    toc: true
    number_sections: true
    toc_depth: 5
    code_folding: show
    #df_print: paged
    #df_print: kable
    #toc_float: true
      #collapsed: false
      #smooth_scroll: TRUE
    theme: cosmo #spacelab #yeti #united #cosmo
    highlight: tango
  pdf_document:
    df_print: kable
fontsize: 12pt
geometry: margin=0.25in
always_allow_html: yes
editor_options: 
  chunk_output_type: console
---

```{=html}
<style>
/* HTML FORMATTING */
h1, .h1, h2, .h2, h3, .h3, h4, .h4, h5, .h5 {
  margin-top: 25px; /* space before each header */
  font-weight: bold; /* bold headers */
}
</style>
```
```{R, echo=FALSE}
# I set some GLOBAL R chunk options here.
#   (to hide this message add "echo=FALSE" to the code chunk options)
#rm(list =ls (all = TRUE)) #This removes objects from global environ
knitr::opts_chunk$set(echo=F, comment = NA, message = FALSE, warning = FALSE, width = 100)
knitr::opts_chunk$set(fig.align = "center", fig.height = 4, fig.width = 6)

```

# Load Packages

```{R}
pacman::p_load(
AMR,
devtools,
magrittr,
ggpubr,
reshape,
reshape2,
performance,
plyr,
dplyr,
tidyr,
tibble,
car,
rcompanion,
GGally,
Hmisc,
gridExtra,
stats,
gplots,
ggplot2,
ggExtra,
cowplot,
colorspace,
stats4, # Forces knitr to work when it's being wonky
PMCMR, #Allows Kruskal-Wallis post-hocs
effects,
gridExtra,
lattice,
survival,
fmsb,
faraway,
ape,
#wBoot,
ggridges,
boot,
effsize,
plotrix,
colorspace,
patchwork,
ggdist,
# Mapping 
raster,
sp,
rgdal,
prettymapr,
viridis,
rasterVis,
# Modeling packages 
nlme,
lme4,
AICcmodavg,
MuMIn,
reghelper,
lsmeans,
rsq, # get r-squared values from GLM
r2glmm, # for R^2 values from lmer(, and glmer(,
multcompView, # related to multiple comparisons?
jtools, # interaction plots 
interactions, # interaction plots 
broom,
stargazer, # model output tables
ggeffects, # for estimating model predictions from mixed effects models
MCMCglmm,
bayesplot,
rstan,
Rcpp, # required for brms
brms,
magrittr,
tidybayes,
modelr,
hexbin,
ggExtra,
rgl,
# Phylo packages 
phytools,
ape, 
extrafont)

# To run each time you load rstan
options(mc.cores = parallel::detectCores()) # for core setup 
rstan_options(auto_write = TRUE) # auto save  bare verion of compiled Stan program to HD

#set cores to run for models
n_core <- parallel::detectCores()-1

#Load in functions
source("~/Desktop/R_color_palettes/Gadek_custom_colors.R")
source("~/Desktop/ggplot_themes/ggplot_themes.R")

theme_set(theme_arial_clean())

#setup folder paths for less coding
figures <- paste(getwd(), "/figures/", sep="")
tables <- paste(getwd(), "/Tables/", sep="")
models <- paste(getwd(), "/models/", sep="")
results <- paste(getwd(), "/models/results/", sep="")
```

# Load in data
```{r}
dat.f <- read_csv("data/crane_conservative_full.csv")
dat.s <- read_csv("data/crane_trimmed_sus.csv")
morpho.massive <- read_csv("data/morpho_massive.csv")

```

# Explore Data

## Descriptive Statistics

### Full dataset

```{R}
#get means and standard deviations
#by subspecies

dat.s %>%
  group_by(taxon_name, sex) %>%
  summarise(
    count = n(),
    mean.trachea.length = mean(mean_trachea_length, na.rm = T),
    sd.mean.trachea.length = sd(mean_trachea_length, na.rm = T),
    mean.mass = mean(mass, na.rm = T),
    sd.mass = sd(mass, na.rm = T),
    mean.BMI.tar = mean(BMI.tars, na.rm = T),
    mean.BMI.trach = mean(BMI.trach, na.rm = T),
    mean.BMI.wing = mean(BMI.wing, na.rm = T),
    mean.segment = mean(segment_count_mean, na.rm = T),
    sd.segment = sd(segment_count_mean, na.rm = T),
    mean.segment.width = mean(segment_width, na.rm = T),
    sd.segment.width = sd(segment_width, na.rm = T)
  )

```

## Descriptive Plots
### Plot mean trachea length between subspecies

Box plots plot because I like them.

```{r, echo=F}
#box plot

p <- dat.s %>%
  group_by(taxon_name) %>%
  ggplot(., aes(taxon_name, mean_trachea_length, fill=taxon_name)) +
  #geom_violin(trim = F) +
  geom_boxplot(width = 0.7, fill="white", outlier.shape = NA) +
  geom_jitter(shape=21, size=3, width = 0.2)+
  scale_x_discrete(labels = c("lesser", "greater")) +
  scale_fill_crane(palette = "cranes")+
  theme(axis.text.x = element_text(face = "plain"),
        legend.position = "none") +
  labs(x = "", y = "mean trachea length (mm)")
p
ggsave(
  p+theme(),
  filename = paste(
    getwd(),
    "/figures/Mean_trachea_length_subspecies_boxplot_conservative.pdf",
    sep = ""
  ),
  bg = "transparent",
  height = 4.5,
  width = 5,
  units = "in",
  device= cairo_pdf
)

```

### Plot mean trachea length between subspecies & sex



```{r, echo=F}


p <- dat.s %>%
  group_by(taxon_name, sex) %>%
  filter(!bursa %in% c("yes")) %>%
  ggplot(., aes(taxon_name, mean_trachea_length, fill = sex)) +
  #geom_violin(trim = F) +
  #geom_box plot(width = 0.1,  position = position_dodge(width = 0.9)) +
  geom_boxplot(width = 0.7,
               alpha = 0.5,
               outlier.shape = NA) +
  geom_point(
    color = "black",
    shape = 21,
    size = 2,
    position = position_jitterdodge(jitter.width = 0.15)
  ) +
  scale_x_discrete(labels = c("lesser", "greater")) +
  scale_fill_sex(palette = "cranes") +
  scale_color_sex(palette = "cranes") +
  theme(axis.text.x = element_text(face = "plain"),
        legend.position = c(0.2, 0.85)) +
  labs(x = "", y = "mean trachea length (mm)")
p
ggsave(
  p,
  filename = paste(
    getwd(),
    "/figures/Mean_trachea_length_subspecies_sex_boxplot_conservative.pdf",
    sep = ""
  ),
  bg = "transparent",
  height = 4.5,
  width = 5,
  units = "in",
  device = cairo_pdf
)

```

### Plot mean mass between subspecies

Box plot

```{r, echo=F}
p <- dat.s %>%
  group_by(taxon_name) %>%
  ggplot(., aes(taxon_name, mass, fill = taxon_name)) +
  #geom_violin(trim = F) +
  geom_boxplot(width = 0.7,
               fill = "white",
               outlier.shape = NA) +
  geom_jitter(shape = 21,
              size = 3,
              width = 0.2) +
  scale_x_discrete(labels = c("lesser", "greater")) +
  scale_fill_crane(palette = "cranes") +
  theme(axis.text.x = element_text(face = "plain"),
        legend.position = "none") +
  labs(x = "", y = "mass (g)")
p
ggsave(
  p,
  filename = paste(
    getwd(),
    "/figures/Mass_subspecies_boxplot_conservative.pdf",
    sep = ""
  ),
  bg = "transparent",
  height = 4.5,
  width = 5,
  units = "in",
  device = cairo_pdf
)

```

### Plot mass by subspecies and sex

```{r, echo=F}

p <- dat.s %>%
  group_by(taxon_name, sex) %>%
  filter(!bursa %in% c("yes")) %>%
  ggplot(., aes(taxon_name, mass, fill = sex)) +
  #geom_violin(trim = F) +
  #geom_box plot(width = 0.1,  position = position_dodge(width = 0.9)) +
  geom_boxplot(width = 0.7,
               alpha = 0.5,
               outlier.shape = NA) +
  geom_point(
    color = "black",
    shape = 21,
    size = 2,
    position = position_jitterdodge(jitter.width = 0.15)
  ) +
  scale_x_discrete(labels = c("lesser", "greater")) +
  scale_fill_sex(palette = "cranes") +
  scale_color_sex(palette = "cranes") +
  theme(axis.text.x = element_text(face = "plain"),
        legend.position = c(0.2, 0.85)) +
  labs(x = "", y = "mass (g)")
p
ggsave(
  p,
  filename = paste(
    getwd(),
    "/figures/Mean_mass_subspecies_sex_boxplot_conservative.pdf",
    sep = ""
  ),
  bg = "transparent",
  height = 4.5,
  width = 5,
  units = "in",
  device = cairo_pdf
)

```

### Plot BMI.tars by subspecies and sex

```{r, echo=F}

p <- dat.s %>%
  group_by(taxon_name, sex) %>%
  filter(!bursa %in% c("yes"),
         mass >= 2400) %>%
  ggplot(., aes(taxon_name, BMI.tars, fill = sex)) +
  geom_boxplot(width = 0.7,
               alpha = 0.5,
               outlier.shape = NA) +
  geom_point(
    color = "black",
    shape = 21,
    size = 2,
    position = position_jitterdodge(jitter.width = 0.15)
  ) +
  scale_x_discrete(labels = c("lesser", "greater")) +
  scale_fill_sex(palette = "cranes") +
  scale_color_sex(palette = "cranes") +
  theme(axis.text.x = element_text(face = "plain"),
        legend.position = c(0.75, 0.75)) +
  labs(x = "", y = "BMI (tarsus)")
p
ggsave(
  p + theme(),
  filename = paste(
    getwd(),
    "/figures/BMI_tars_subspecies_sex_boxplot_conservative.pdf",
    sep = ""
  ),
  bg = "transparent",
  height = 4.5,
  width = 5,
  units = "in"
)

```
NOTE there is a oddly small tarsus measurement for one lesser female. If we want to do something with tarsus we may want to remove...

### Plot BMI.trach by subspecies and sex

```{r, echo=F}

p <- dat.s %>%
  group_by(taxon_name, sex) %>%
  filter(!bursa %in% c("yes"),
         mass >= 2400) %>%
  ggplot(., aes(taxon_name, BMI.trach, fill = sex)) +
  # geom_violin(trim = F) +
  # geom_box plot(width = 0.1,  position = position_dodge(width = 0.9)) +
  # theme_classic(base_size = 14) +
  geom_boxplot(width = 0.7,
               alpha = 0.5,
               outlier.shape = NA) +
  geom_point(
    aes(fill = sex),
    color = "black",
    shape = 21,
    size = 2,
    position = position_jitterdodge(jitter.width = 0.15)
  ) +
  scale_x_discrete(labels = c("lesser", "greater")) +
  scale_fill_sex(palette = "cranes") +
  theme(axis.text.x = element_text(face = "plain"),
        legend.position = c(0.2, 0.85)) +
  labs(x = "", y = "BMI (trachea)")
p
ggsave(
  p + theme(),
  filename = paste(
    getwd(),
    "/figures/BMI_trach_subspecies_sex_boxplot_conservative.pdf",
    sep = ""
  ),
  bg = "transparent",
  height = 4.5,
  width = 5,
  units = "in"
)

```

### Plot BMI.wing by subspecies and sex

```{r, echo=F}

p <- dat.s %>%
  group_by(taxon_name, sex) %>%
  filter(!bursa %in% c("yes"),
         mass >= 2400) %>%
  ggplot(., aes(taxon_name, BMI.wing, fill = sex)) +
  # geom_violin(trim = F) +
  # geom_box plot(width = 0.1,  position = position_dodge(width = 0.9)) +
  # theme_classic(base_size = 14) +
  geom_boxplot(width = 0.7,
               alpha = 0.5,
               outlier.shape = NA) +
  geom_point(
    aes(fill = sex),
    color = "black",
    shape = 21,
    size = 2,
    position = position_jitterdodge(jitter.width = 0.15)
  ) +
  scale_x_discrete(labels = c("lesser", "greater")) +
  scale_fill_sex(palette = "cranes") +
  theme(axis.text.x = element_text(face = "plain"),
        legend.position = c(0.2, 0.85)) +
  labs(x = "", y = "BMI (wing chord)")
p
ggsave(
  p,
  filename = paste(
    getwd(),
    "/figures/BMI_wing_subspecies_sex_boxplot_conservative.pdf",
    sep = ""
  ),
  bg = "transparent",
  height = 4.5,
  width = 5,
  units = "in"
)

```

Note some wing outliers. These will need to be dealt with when conducting morphometric PCA

### Plot residual by subspecies and sex

```{r, echo=F}
#violin plot
p <- dat.s %>%
  group_by(taxon_name, sex) %>%
  filter(!bursa %in% c("yes"),
         mass >= 2400) %>%
  ggplot(., aes(taxon_name, r, fill = sex)) +
  # geom_violin(trim = F) +
  # geom_box plot(width = 0.1,  position = position_dodge(width = 0.9)) +
  # theme_classic(base_size = 14) +
  geom_boxplot( width = 0.7, alpha=0.5,, outlier.shape = NA) +
  geom_point(color="black", shape=21, size=2, position=position_jitterdodge(jitter.width = 0.15))+
  scale_x_discrete(labels = c("lesser", "greater")) +
  scale_fill_sex(palette = "cranes") +
  theme(axis.text.x = element_text(face = "plain"),
        legend.position = "none") +
  labs(x = "", y = "residuals(log(mtl ~ mass))")
p
ggsave(
  p +theme(),
  filename = paste(
    getwd(),
    "/figures/Residual_subspecies_sex_boxplot_conservative.pdf",
    sep = ""
  ),
  bg = "transparent",
  height = 4.5,
  width = 5,
  units = "in"
)

```
One residual outlier lesser female. Consider removing...

### Plot tarsus by subspecies and sex

```{r, echo=F}
#box plot
p<-dat.s %>%
  group_by(taxon_name, sex)%>%
  filter(!bursa %in% c("yes"),
         mass >= 2400)%>%
  ggplot(., aes(taxon_name, tarsus, fill=sex))+
  # geom_violin(trim=F)+
  # geom_box plot(width=0.1,  position = position_dodge(width = 0.9))+
  # theme_classic(base_size = 14)+
  geom_boxplot( width = 0.7, alpha=0.5, outlier.shape = NA) +
  geom_point(color="black", shape=21, size=2, position=position_jitterdodge(jitter.width = 0.15))+
  scale_x_discrete(labels=c("A. c. canadensis", "A. c. tabida"))+
  scale_fill_sex(palette = "cranes")+
  theme(axis.text.x = element_text(face = "plain"),
        legend.position = c(0.2,0.85))+
  labs(x="", y= "tarsus (mm)")
p
  ggsave(p +theme(), filename = paste(getwd(), "/figures/Tarsus_subspecies_sex_boxplot_conservative.pdf", sep=""),  bg = "transparent", height = 4.5, width = 5, units = "in")

```

### Plot wing by subspecies and sex

```{r, echo=F}
#box plot
p<-dat.s %>%
  group_by(taxon_name, sex)%>%
  filter(!bursa %in% c("yes"),
         mass >= 2400)%>%
  ggplot(., aes(taxon_name, wing.chord, fill=sex))+
  # geom_violin(trim=F)+
  # geom_box plot(width=0.1,  position = position_dodge(width = 0.9))+
  # theme_classic(base_size = 14)+
   geom_boxplot( width = 0.7, alpha=0.5, outlier.shape = NA) +
  geom_point(color="black", shape=21, size=2, position=position_jitterdodge(jitter.width = 0.15))+
  scale_x_discrete(labels=c("A. c. canadensis", "A. c. tabida"))+
  scale_fill_sex(palette = "cranes")+
  theme(axis.text.x = element_text(face = "plain"),
        legend.position = c(0.2,0.85))+
  labs(x="", y= "wing chord (mm)")
p
  ggsave(p + theme(), filename = paste(getwd(), "/figures/Wing_chord_subspecies_sex_boxplot_conservative.pdf", sep=""),  bg = "transparent", height = 4.5, width = 5, units = "in")

```

### Plot anterior culmen by subspecies and sex

```{r, echo=F}
#box plot
p<-dat.s %>%
  group_by(taxon_name, sex)%>%
  filter(!bursa %in% c("yes"),
         mass >= 2400)%>%
  ggplot(., aes(taxon_name, anterior.culmen, fill=sex))+
  # geom_violin(trim=F)+
  # geom_box plot(width=0.1,  position = position_dodge(width = 0.9))+
  # theme_classic(base_size = 14)+
  geom_boxplot( width = 0.7, alpha=0.5, outlier.shape = NA) +
  geom_point(color="black", shape=21, size=2, position=position_jitterdodge(jitter.width = 0.15))+
  scale_x_discrete(labels=c("A. c. canadensis", "A. c. tabida"))+
  scale_fill_sex(palette = "cranes")+
  theme(axis.text.x = element_text(face = "plain"),
        legend.position = c(0.2,0.85))+
  labs(x="", y= "anterior culmen (mm)")
p
  ggsave(p + theme(), filename = paste(getwd(), "/figures/Anterior_culmen_subspecies_sex_boxplot_conservative.pdf", sep=""),  bg = "transparent", height = 4.5, width = 5, units = "in")

```

### Plot proportion trachea by subspecies and sex

```{r, echo=F}
#box plot
p <- dat.s %>%
  group_by(taxon_name, sex) %>%
  filter(!bursa %in% c("yes"),
         mass >= 2400,
         prop_trachea <0.225) %>%
  ggplot(., aes(taxon_name, prop_trachea, fill = sex)) +
  # geom_violin(trim=F)+
  # geom_box plot(width=0.1,  position = position_dodge(width = 0.9))+
  # theme_classic(base_size = 14)+
  geom_boxplot(width = 0.7,
               alpha = 0.5,
               outlier.shape = NA) +
  geom_point(
    color = "black",
    shape = 21,
    size = 2,
    position = position_jitterdodge(jitter.width = 0.15)
  ) +
  scale_x_discrete(labels = c("lesser", "greater")) +
  scale_fill_sex(palette = "cranes") +
  theme(axis.text.x = element_text(face = "plain"),
        legend.position = c(0.8, 0.85)) +
  labs(x = "", y = "proportion trachea")
p
ggsave(
  p + theme(),
  filename = paste(
    getwd(),
    "/figures/Proportion_trachea_subspecies_sex_boxplot_conservative.pdf",
    sep = ""
  ),
  bg = "transparent",
  height = 4.5,
  width = 5,
  units = "in",
  device = cairo_pdf
)

```

### Segment count between subspecies and sex

```{r, echo=F}
#violin plot
p<-dat.s %>%
  group_by(taxon_name, sex)%>%
  filter(!bursa %in% c("yes"),
         mass >= 2400,
         segment_count2 < 350)%>%
  ggplot(., aes(taxon_name, segment_count2, fill=sex))+
  # geom_violin(trim=F)+
  # geom_box plot(width=0.1,  position = position_dodge(width = 0.9))+
  # theme_classic(base_size = 14)+
  geom_boxplot( width = 0.7, alpha=0.5, outlier.shape = NA) +
  geom_point(color="black", shape=21, size=2, position=position_jitterdodge(jitter.width = 0.15))+
  scale_x_discrete(labels=c("A. c. canadensis", "A. c. tabida"))+
  scale_fill_sex(palette = "cranes")+
  theme(axis.text.x = element_text(face = "plain"),
        legend.position = c(0.15,0.9))+
  labs(x="", y= "segment count")
p
  ggsave(p + theme(), filename = paste(getwd(), "/figures/Segment_count_subspecies_sex_boxplot_conservative.pdf", sep=""),  bg = "transparent", height = 4.5, width = 5, units = "in")

```

### Segment density between subspecies and sex

```{r, echo=F}
#violin plot
p<-dat.s %>%
  group_by(taxon_name, sex)%>%
  filter(!bursa %in% c("yes"),
         mass >= 2400)%>%
  ggplot(., aes(taxon_name, segment_width, fill=sex))+
  # geom_violin(trim=F)+
  # geom_box plot(width=0.1,  position = position_dodge(width = 0.9))+
  # theme_classic(base_size = 14)+
  geom_boxplot( width = 0.7, alpha=0.5, outlier.shape = NA) +
  geom_point(color="black", shape=21, size=2, position=position_jitterdodge(jitter.width = 0.15))+
  scale_x_discrete(labels=c("A. c. canadensis", "A. c. tabida"))+
  scale_fill_sex(palette = "cranes")+
  theme(axis.text.x = element_text(face = "plain"),
        legend.position = c(0.2,0.85))+
  labs(x="", y= "segment width")
p
  ggsave(p + theme(), filename = paste(getwd(), "/figures/segment_width_subspecies_sex_boxplot_conservative.pdf", sep=""),  bg = "transparent", height = 4.5, width = 5, units = "in")

```

### Segment count between subspecies and age

```{r, echo=F}
#violin plot
p<-dat.s %>%
  group_by(taxon_name, sex)%>%
  filter(mass >= 2400,
         bursa %in% c("Y", "N"),
         segment_count2 < 350)%>%
  ggplot(., aes(taxon_name, segment_count2, fill=bursa))+
  # geom_violin(trim=F, alpha=0.5)+
  # geom_box plot(width=0.1,  position = position_dodge(width = 0.9))+
  # theme_classic(base_size = 14)+
  geom_boxplot( width = 0.7, alpha=0.5, outlier.shape = NA) +
  geom_point(color="black", shape=21, size=2, position=position_jitterdodge())+
  scale_x_discrete(labels=c("A. c. canadensis", "A. c. tabida"))+
  scale_fill_deleuze(palette = "deleuze")+
  theme(axis.text.x = element_text(face = "plain"),
        legend.position = c(0.88,0.88))+
  labs(x="", y= "segment count")
p
  ggsave(p + theme(), filename = paste(getwd(), "/figures/Segment_count_subspecies_age_boxplot_conservative.pdf", sep=""),  bg = "transparent", height = 4, width = 4, units = "in")

```

### Segment count for young birds between sexes and species
```{r, echo=F}
#box plot
p<-dat.s %>%
  group_by(taxon_name, sex)%>%
  filter(mass >= 2400,
         bursa %in% c("Y", "N"),
         segment_count2 < 350)%>%
  ggplot(., aes(taxon_name, segment_count2, fill=sex))+
  #geom_violin(trim=F)+
  # geom_box plot(outlier.shape=NA)+
  # geom_point(position=position_jitterdodge())+
  geom_boxplot( width = 0.7, alpha=0.5, outlier.shape = NA) +
  geom_point(color="black", shape=21, size=2, position=position_jitterdodge(jitter.width = 0.15))+
  scale_x_discrete(labels=c("A. c. canadensis", "A. c. tabida"))+
  scale_fill_deleuze(palette = "cranes")+
  theme(axis.text.x = element_text(face = "plain"),
        legend.position = "none")+  #c(0.2,0.85)
  labs(x="", y= "segment count")+
  facet_wrap(.~bursa)
p
  ggsave(p+ theme(), filename = paste(getwd(), "/figures/Segment_count_subspecies_age_boxplot_conservative.pdf", sep=""),  bg = "transparent", height = 4.5, width = 5, units = "in")

```

### Segment density between subspecies and age

```{r, echo=F}
#violin plot
p<-dat.s %>%
  group_by(taxon_name, sex)%>%
  filter(mass >= 2400,
         bursa %in% c("Y", "N"))%>%
  ggplot(., aes(taxon_name, segment_width, fill=sex))+
  # geom_violin(trim=F)+
  # geom_boxplot(width=0.1,  position = position_dodge(width = 0.9))+
  # theme_classic(base_size = 14)+
  geom_boxplot( width = 0.7, alpha=0.5, outlier.shape = NA) +
  geom_point(color="black", shape=21, size=2, position=position_jitterdodge())+
  scale_x_discrete(labels=c("A. c. canadensis", "A. c. tabida"))+
  scale_fill_sex(palette = "cranes")+
  theme(axis.text.x = element_text(face = "plain"),
        legend.position = c(0.6,0.85))+
  labs(x="", y= "segment width")+
  facet_wrap(.~bursa)
p
  ggsave(p + theme(), filename = paste(getwd(), "/figures/segment_width_subspecies_age_boxplot_conservative.pdf", sep=""),  bg = "transparent", height = 4.5, width = 5, units = "in")

```

### T-tests 

```{r}

t.test(mass ~ taxon_name, data=subset(dat.s, sex %in% c("M", "F")))

t.test(mean_trachea_length ~ taxon_name, data=subset(dat.s, sex %in% c("M", "F")))

t.test(mass ~ sex, data=subset(dat.g, sex %in% c("M", "F")))

t.test(mass ~ sex, data=subset(dat.l, sex %in% c("M", "F")))

t.test(mean_trachea_length ~ sex, data=subset(dat.l, sex %in% c("M", "F")))

t.test(mean_trachea_length ~ sex, data=subset(dat.g, sex %in% c("M", "F")))

t.test(prop_trachea ~ taxon_name, data=subset(dat.s, sex %in% c("M", "F")))

t.test(prop_trachea ~ sex, data=subset(dat.g, sex %in% c("M", "F")))

t.test(prop_trachea ~ sex, data=subset(dat.l, sex %in% c("M", "F")))

t.test(segment_count2 ~ taxon_name, data=subset(dat.s, sex %in% c("M", "F")))

t.test(segment_width ~ taxon_name, data=subset(dat.s, sex %in% c("M", "F")))

t.test(segment_count2 ~ sex, data=subset(dat.l, sex %in% c("M", "F")))

t.test(segment_count2 ~ sex, data=subset(dat.g, sex %in% c("M", "F")))


t.test(segment_width ~ sex, data=subset(dat.l, sex %in% c("M", "F")))

t.test(segment_width~ sex, data=subset(dat.g, sex %in% c("M", "F")))

```

## Scatter Plots

### Segment width by mass by sex

```{r, echo=F}

p <- dat.s %>%
  group_by(taxon_name, sex) %>%
  filter(mass >= 2400,
         bursa %in% c("Y", "N")) %>%
  ggplot(., aes(
    log_mass ,
    log10(segment_width),
    fill = sex,
    color = sex
  )) +
  geom_point(shape = 21, color = "black", size=2) +
  geom_smooth(method = "lm", linetype="dashed", color= "black") +
  scale_fill_crane(palette = "cranes") +
  scale_color_crane(palette = "cranes") +
  theme(
        legend.position = c(0.6, 0.2)) +
  labs(x = "mass", y = "segment width") +
  facet_wrap(. ~ taxon_name)
p
ggsave(
  p + theme(),
  filename = paste(
    getwd(),
    "/figures/Segment_width_mass_scatter_conservative.pdf",
    sep = ""
  ),
  bg = "transparent",
  height = 4.5,
  width = 5,
  units = "in"
)

```

### Segment width by mass by taxon

```{r, echo=F}


p <- dat.s %>%
  group_by(taxon_name, sex) %>%
  filter(mass >= 2400,
         bursa %in% c("Y", "N")) %>%
  ggplot(.,
         aes(
           mean_trachea_length ,
           segment_width,
           fill = taxon_name,
           color = taxon_name
         )) +
  geom_point(shape = 21, color = "black", size=2) +
  geom_smooth(method = "lm", linetype="dashed", color= "black") +
  scale_fill_sex(palette = "cranes") +
  scale_color_sex(palette = "cranes") +
  theme(axis.text.x = element_text(face = "plain"),
        legend.position = c(0.3, 0.88)) +
  labs(x = "mass", y = "segment width")
p
ggsave(
  p + theme(),
  filename = paste(
    getwd(),
    "/figures/Segment_width_mass_scatter_conservative.pdf",
    sep = ""
  ),
  bg = "transparent",
  height = 4.5,
  width = 5,
  units = "in"
)

```

### Segment density by residuals mtl\~logmass subspecies

```{r, echo=F}

p <- dat.s %>%
  group_by(taxon_name, sex) %>%
  filter(mass >= 2400,
         bursa %in% c("Y", "N")) %>%
  ggplot(., aes(r, segment_width, fill = sex, color = sex)) +
  geom_point(shape = 21, color = "black", size=2) +
  geom_smooth(method = "lm", color="black", linetype="dashed", size=1) +
  theme_classic(base_size = 14) +
  scale_fill_sex(palette = "cranes") +
  scale_color_sex(palette = "cranes") +
  theme(axis.text.x = element_text(face = "plain"),
        legend.position = c(0.9, 0.2)) +
  labs(x = "residuals", y = "segment width") +
  facet_wrap(. ~ taxon_name)
p
ggsave(
  p,
  filename = paste(
    getwd(),
    "/figures/segment_width_resid_subspecies_scatter_conservative.pdf",
    sep = ""
  ),
  bg = "transparent",
  height = 4,
  width = 8,
  units = "in"
)

```

### Segment count by mass
```{r, echo=F}

p <- dat.s %>%
  group_by(taxon_name, sex) %>%
  filter(mass >= 2400,
         bursa %in% c("Y", "N")) %>%
  ggplot(., aes(
    log_mtl ,
    log10(segment_count_mean),
    fill = sex,
    color = sex
  )) +
  geom_point(shape = 21, color = "black") +
  geom_smooth(method = "lm",, linetype="dashed", color= "black") +
  scale_fill_crane(palette = "cranes") +
  scale_color_crane(palette = "cranes") +
  theme(axis.text.x = element_text(face = "plain"),
        legend.position = "none") +
  labs(x = "mass", y = "ring number") +
  facet_wrap(. ~ taxon_name)
p
ggsave(
  p + theme(),
  filename = paste(
    getwd(),
    "/figures/Segment_width_mass_scatter_conservative.pdf",
    sep = ""
  ),
  bg = "transparent",
  height = 4.5,
  width = 5,
  units = "in"
)

```
### Mtl by mass by taxon

```{r}
p <-
  ggplot(dat.s,
         aes(
           x = log_mass,
           y = log_mtl,
           group = sex,
           fill = sex
         )) #substitute dat.s to remove tabida outliers, leave dat.f to see them
p <- p + geom_point(
  shape = 21,
  color = "black",
  size = 2,
  alpha = 0.7
)
p <- p + geom_smooth(fill = "grey68",
                     method = "lm",
                     alpha = 0.2,, linetype="dashed", color= "black")
p <- p + theme_bw()
p <- p + scale_fill_crane(palette = "cranes")
p <- p + scale_color_crane(palette = "cranes")
#p <- p + scale_y_continuous(breaks=c(2.60206, 2.69897, 2.778151, 2.845098, 2.90309), labels=c("400", "500", "600","700","800"))
#p <- p + scale_x_continuous(breaks=c(3.477121, 3.60206,   3.69897, 3.778151, 3.845098), labels=c( "3000", "4000", "5000", "6000", "7000"))
p <-
  p + theme(panel.grid.major = element_blank(),
            panel.grid.minor = element_blank())
p <- p + theme(
  legend.position = c(0.9, 0.2)
)
p <- p + facet_wrap( ~ taxon_name, scales = "free_x")
#p <- p + theme(strip.text = element_text(face = "plain", size=14), legend.position = "none")
p <-
  p + labs(x = expression(paste("log10(mass)", " (g)"), sep = ""), y = "log10(trachea length (mm))")
# p <- p + stat_poly_eq(aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")),
#                label.x.npc = "right", label.y.npc = 0.15,
#                formula = formula, parse = TRUE, size = 3)
print(p)

ggsave(
  p,
  filename = "Mtl_by_mass.png",
  height = 4.5,
  width = 5,
  units = "in",
  device = cairo_pdf
)

```

### Two panel marginal density mtl ~ segment density
```{r}

plot1 <- ggplot(dat.g, aes(x = segment_width, y =mean_trachea_length, fill=sex)) + 
  geom_point(shape = 21, color = "black", size = 2) + 
  stat_smooth(method = "lm", fullrange = F, linetype="dashed", color= "black") +
  scale_fill_crane(palette = "cranes")+
  scale_color_crane(palette = "cranes")+
  scale_y_continuous(name = "trachea length (mm)", limits=c(min(dat.g$mean_trachea_length -10), max(dat.g$mean_trachea_length +5)))+
  scale_x_continuous(name = "segment width", limits= c(1.6, 2.9), expand = c(0,0)) + 
  theme_pubr() +
  theme(legend.position = c(0.15, 0.85))

dens1 <- ggplot(dat.g, aes(x = segment_width, fill = sex)) + 
  geom_density(alpha = 0.4, adjust=3) + 
  #scale_x_continuous(limits = c(2,2.9)) + 
  scale_fill_crane(palette = "cranes")+
  theme_void() + 
  theme(legend.position = "none",
        legend.title =  element_blank())


dens2 <- ggplot(dat.g, aes(x = mean_trachea_length, fill = sex)) + 
  geom_density(alpha = 0.4, adjust=3,) + 
  scale_x_continuous(limits=c(min(dat.g$mean_trachea_length -10), max(dat.g$mean_trachea_length +10))) + 
  scale_fill_crane(palette = "cranes")+
  theme_void() + 
  theme(legend.position = "none") + 
  coord_flip()


p<-dens1 + plot_spacer() + plot1 + dens2 + 
  plot_layout(ncol = 2, nrow = 2, widths = c(4, 1), heights = c(1, 4))
p
ggsave(p + theme(), filename = "figures/mtl_by_seg_width_greater_conservative.pdf", height = 6, width = 6,  units = "in", device = cairo_pdf)



plot1 <- ggplot(dat.l%>%filter(bursa %in% c("N", "NA")), aes(x = segment_width, y = mean_trachea_length, color = sex, fill=sex)) + 
  geom_point(aes(color = sex), size = 3) + 
  geom_point(shape = 1, color = "black", size = 3) + 
  stat_smooth(method = "lm", fullrange = F) +
  scale_fill_crane(palette = "cranes")+
  scale_color_crane(palette = "cranes")+
  scale_y_continuous(name = "trachea length (mm)", limits=c(min(dat.l$mean_trachea_length -20), max(dat.l$mean_trachea_length +20)), expand = c(0,0))+
  scale_x_continuous(name = "segment width", limits= c(1.4,2.8), expand = c(0,0)) + 
  theme_pubr() +
  theme(legend.position = c(0.15, 0.9))

dens1 <- ggplot(dat.l%>%filter(bursa %in% c("N", "NA")), aes(x = segment_width, fill = sex)) + 
  geom_density(alpha = 0.4, adjust=3) + 
  scale_x_continuous(limits = c(1.4,2.8)) + 
  scale_fill_crane(palette = "cranes")+
  theme_void() + 
  theme(legend.position = "none",
        legend.title =  element_blank())


dens2 <- ggplot(dat.l%>%filter(bursa %in% c("N", "NA")), aes(x = mean_trachea_length, fill = sex)) + 
  geom_density(alpha = 0.4, adjust=3) + 
  scale_x_continuous(limits=c(min(dat.l$mean_trachea_length -20), max(dat.l$mean_trachea_length +20))) + 
  scale_fill_crane(palette = "cranes")+
  theme_void() + 
  theme(legend.position = "none") + 
  coord_flip()


p<-dens1 + plot_spacer() + plot1 + dens2 + 
  plot_layout(ncol = 2, nrow = 2, widths = c(4, 1), heights = c(1, 4))
p
ggsave(p, filename = "figures/mtl_by_seg_count_lesser_conservative.pdf", height = 6, width = 6,  units = "in", device = cairo_pdf)
```

### Two panel marginal density by taxon mtl ~ segment density
```{r}

plot1 <- ggplot(dat.s, aes(x = segment_width, y =mean_trachea_length, color = taxon_name, fill=taxon_name)) + 
  geom_point(aes(color = taxon_name), size = 3) + 
  geom_point(shape = 1, color = "black", size = 3) + 
  stat_smooth(method = "lm", fullrange = F) +
  scale_fill_crane(palette = "cranes")+
  scale_color_crane(palette = "cranes")+
  scale_y_continuous(name = "trachea length (mm)", limits=c(min(dat.s$mean_trachea_length -10), max(dat.s$mean_trachea_length +5)))+
  scale_x_continuous(name = "segment width", limits= c(1.6, 2.9), expand = c(0,0)) + 
  theme_pubr() +
  theme(legend.position = c(0.35, 0.9),
        legend.title =  element_blank())

dens1 <- ggplot(dat.s, aes(x = segment_width, fill = taxon_name)) + 
  geom_density(alpha = 0.4, adjust=3) + 
  #scale_x_continuous(limits = c(2,2.9)) + 
  scale_fill_crane(palette = "cranes")+
  theme_void() + 
  theme(legend.position = "none",
        legend.title =  element_blank())


dens2 <- ggplot(dat.s, aes(x = mean_trachea_length, fill = taxon_name)) + 
  geom_density(alpha = 0.4, adjust=3,) + 
  scale_x_continuous(limits=c(min(dat.s$mean_trachea_length -10), max(dat.s$mean_trachea_length +10))) + 
  scale_fill_crane(palette = "cranes")+
  theme_void() + 
  theme(legend.position = "none",
        legend.title = element_blank()) + 
  coord_flip()


p<-dens1 + plot_spacer() + plot1 + dens2 + 
  plot_layout(ncol = 2, nrow = 2, widths = c(4, 1), heights = c(1, 4))
p
ggsave(p, filename = "figures/mtl_by_seg_width_greater_conservative.pdf", height = 6, width = 6,  units = "in", device = cairo_pdf)

```

## Weird trachea map experiment
```{r, `trachmap`, eval=F, include=F}

t<-as.numeric(cut_number(dat.g$mean_trachea_length, n=5))


dat.s%>%
  dplyr::select(3:4, 6, 13, 17, 30, 16, 14, 31)%>%
  na.omit()%>%
  group_by(NK)%>%
  pivot_longer(
    cols = (4:8),
    names_to = c("trach_part"),
    values_to = "measure"
  ) %>%
  mutate(trach_part = factor(fct_relevel(trach_part, "anterior_width", "width_straight_mdpt", "width_1st_curve", "width_2nd_curve", "poserior_width" )))%>%
  ungroup()%>%
  group_by(taxon_name.x, sex, trach_part)%>%
  mutate(measure_mid = measure/2,
         measure_mean = mean(measure),
            upper = measure_mean + measure_mid,
            lower = measure_mean-measure_mid,
            measure_mid=0)%>%
  ungroup()%>%
  mutate(trach_seq=t)%>%
  ggplot(., aes(trach_seq, measure_mean, fill=sex))+
  geom_ribbon(aes(ymin=lower, ymax=upper), alpha=0.3)+
  scale_fill_sex("cranes")+
  facet_wrap(.~taxon_name.x)
  

 

```

## MDS
```{r, 'MDStaxon'}
select.cols.big <-c(33:34,20, 5:14, 21:23, 26)
select.cols.little <-c(5:14, 21:23, 26)

# Compute MDS
mds.plot <- dat.s%>%
  filter(bursa=="N")%>%
  dplyr::select(NK, select.cols.big)%>%
  unite('id', 1:4, remove = F)%>%
  column_to_rownames(., var="id")%>%
  na.omit()%>%
  group_by(taxon_name, sex)%>%
  summarise(
            across(2:7, ~ log10(.x +0.000001)))
  
  
mds <- mds.plot%>%
  dist() %>%          
  cmdscale() %>%
  as_tibble()
colnames(mds) <- c("Dimension 1", "Dimension 2")
mds$sex <- mds.plot$sex
mds$taxon_name <- mds.plot$taxon_name
# Plot MDS
p<-ggscatter(mds, x = "Dimension 1", y = "Dimension 2", 
          fill = "taxon_name",
          label = NULL,
          size = 3,
          shape = 21,
          ellipse = T,
          ellipse.type = "convex",
          ellipse.alpha = 0.3,
          repel = TRUE,
          rug=F,
          font.label = c(7, "italic"),
          palette = c("seashell3","#A62800"))
p

ggsave(p, file=paste0(figures, "MDS_facetted_by_taxon.pdf"), height=3.5, width=4, device = cairo_pdf)
```
 
 
```{r, `MDSsex`}
p<-ggscatter(mds, x = "Dimension 1", y = "Dimension 2", 
          fill = "sex",
          label = NULL,
          size = 2.5,
          ellipse = T,
          shape=21,
          ellipse.type = "convex",
          repel = TRUE,
          rug=F,
          conf.int = T,
          font.label = c(7, "regular"),
          palette = c("seashell3","#A62800"),
          facet.by = "taxon_name")
 p
 ggsave(p, file=paste0(figures, "MDS_facetted_by_sex.pdf"), height=3.3, width=5, device = cairo_pdf)

```


## PCA
### Trachea
```{r `PCAtaxon`}
select.cols.big <-c(33:34,20, 5:14, 21:23, 26)
select.cols.little <-c(5:14, 21:23, 26)

pca.cols.to.add <-dat.s%>%
  dplyr::select(all_of(select.cols.big))%>%
  na.omit()%>%
  dplyr::select(1:3)

pca.f<-dat.s%>%
  dplyr::select(all_of(select.cols.little))%>%
  na.omit()%>%
  prcomp(., center=T,
         scale=T)

print(pca.f)
plot(pca.f, type = "l")
summary(pca.f)
predict(pca.f, 
        newdata=tail(dat.s%>%
  dplyr::select(all_of(select.cols.little))%>%
  na.omit(), 2))

pca.data<- as.data.frame(pca.f$x)

pca.data$species <- pca.cols.to.add$taxon_name
pca.data$sex <- pca.cols.to.add$sex


g<-ggplot(pca.data, aes(x=PC1, y=PC2, fill = species))+
  geom_point(shape=21, size=3)+
  stat_ellipse()+ #default is 0.95 and type t which assumes a multivariate t distribution
  scale_fill_crane("cranes")+
  theme(legend.position = "top")
g

ggsave(g +theme(), filename = paste0(figures,"Crane_trach_PCA_conservative.pdf"), height = 4.5, width = 4.5, units = "in", device = cairo_pdf)
```


```{r}
g<-ggplot(pca.data, aes(x=PC1, y=PC2, fill = sex))+
  geom_point(shape=21, size=2)+
  stat_ellipse()+
  facet_wrap(.~species)+
  scale_fill_sex("sexes")+
  theme(legend.position = "top")
g

ggsave(g +theme(), filename = paste0(figures,"Crane_trach_PCA_sex_conservative.pdf"), height = 3.2, width = 4.5, units = "in", device = cairo_pdf)

```

### Biplot
greaters 
```{r, `greaterOnlyPCA`}

pca.cols.to.add <-dat.s%>%
  filter(taxon_name=="Antigone canadensis tabida")%>%
  dplyr::select(all_of(select.cols.big))%>%
  na.omit()%>%
  dplyr::select(1:3)

pca.f<-dat.s%>%
  filter(taxon_name=="Antigone canadensis tabida")%>%
  dplyr::select(all_of(select.cols.little))%>%
  na.omit()%>%
  prcomp(., center=T,
         scale=T)

print(pca.f)
plot(pca.f, type = "l")
summary(pca.f)

```

```{r `greaterBiplot`}

p<-ggplot_pca(pca.f,
           fill=as.character(pca.cols.to.add$sex),
           groups = pca.cols.to.add%>%dplyr::select(sex)%>% mutate(sex = as.character(sex))%>%pull(),
           ellipse = T)
p 

ggsave(p +theme(), filename = paste0(figures,"Greater_trach_PCA_biplot_sex_conservative.pdf"), height = 3.2, width = 4.5, units = "in", device = cairo_pdf)
```

lesser
```{r, `lesserOnlyPCA`}

pca.cols.to.add <-dat.s%>%
  filter(taxon_name=="Antigone canadensis canadensis")%>%
  dplyr::select(all_of(select.cols.big))%>%
  na.omit()%>%
  dplyr::select(1:3)

pca.f<-dat.s%>%
  filter(taxon_name=="Antigone canadensis canadensis")%>%
  dplyr::select(all_of(select.cols.little))%>%
  na.omit()%>%
  prcomp(., center=T,
         scale=T)

print(pca.f)
plot(pca.f, type = "l")
summary(pca.f)

```

```{r `lesserBiplot`}

p<-ggplot_pca(pca.f,
           fill=as.character(pca.cols.to.add$sex),
           groups = pca.cols.to.add%>%dplyr::select(sex)%>% mutate(sex = as.character(sex))%>%pull(),
           ellipse = T)
p 

ggsave(p +theme(), filename = paste0(figures,"Lesser_trach_PCA_biplot_sex_conservative.pdf"), height = 3.2, width = 4.5, units = "in", device = cairo_pdf)
```

### Euclidean and Manhattan Distances Between sexes
greaters
```{r}

pca.cols.to.add <-dat.s%>%
  filter(taxon_name == "Antigone canadensis tabida")%>%
  dplyr::select(all_of(select.cols.big))%>%
  na.omit()%>%
  dplyr::select(1:3)

pca.f<-dat.s%>%
  filter(taxon_name == "Antigone canadensis tabida")%>%
  dplyr::select(all_of(select.cols.little))%>%
  na.omit()%>%
  prcomp(., center=T,
         scale=T)

pca.data<- as.data.frame(pca.f$x)

pca.data$species <- pca.cols.to.add$taxon_name
pca.data$sex <- pca.cols.to.add$sex
pca.data$mass <- pca.cols.to.add$mass
pca.data$log_mass.z <- scale(log10(pca.cols.to.add$mass))

 
#find distances between greater sexes

pca.centroids <- aggregate(pca.data[,1:12], list(Type = pca.data$sex), mean)

#euclidean
dist(rbind(pca.centroids[pca.centroids$Type == "M",2:3],pca.centroids[pca.centroids$Type == "F",2:3]), method = "euclidean")

#manhattan
dist(rbind(pca.centroids[pca.centroids$Type == "M",2:3],pca.centroids[pca.centroids$Type == "F",2:3]), method = "manhattan")



#now bind PC1 and d.ev.else to get baysian modeling dataframe
greater.trach.pc <- pca.data

```

lessers
```{r}
pca.cols.to.add <-dat.s%>%
  filter(taxon_name == "Antigone canadensis canadensis")%>%
  dplyr::select(all_of(select.cols.big))%>%
  na.omit()%>%
  dplyr::select(1:3)

pca.f<-dat.s%>%
  filter(taxon_name == "Antigone canadensis canadensis")%>%
  dplyr::select(all_of(select.cols.little))%>%
  na.omit()%>%
  prcomp(., center=T,
         scale=T)

pca.data<- as.data.frame(pca.f$x)

pca.data$species <- pca.cols.to.add$taxon_name.x
pca.data$sex <- pca.cols.to.add$sex
pca.data$mass <- pca.cols.to.add$mass

 
#find distances between greater sexes

pca.centroids <- aggregate(pca.data[,1:12], list(Type = pca.data$sex), mean)

#euclidean
dist(rbind(pca.centroids[pca.centroids$Type == "M",2:3],pca.centroids[pca.centroids$Type == "F",2:3]), method = "euclidean")

#manhattan
dist(rbind(pca.centroids[pca.centroids$Type == "M",2:3],pca.centroids[pca.centroids$Type == "F",2:3]), method = "manhattan")

#now bind PC1 and d.ev.else to get baysian modeling dataframe
lesser.trach.pc <- pca.data

```


### Wing, bill, tarsus
```{r `PCAtaxon`}
select.cols.big<-c(33:34, 20, 15:19)
select.cols.little<-c(15:19)

pca.cols.to.add <-dat.s%>%
  dplyr::select(all_of(select.cols.big))%>%
  na.omit()%>%
  dplyr::select(1:3)

pca.f<-dat.s%>%
  dplyr::select(all_of(select.cols.little))%>%
  na.omit()%>%
  prcomp(., center=T,
         scale=T)

print(pca.f)
plot(pca.f, type = "l")
summary(pca.f)
predict(pca.f, 
        newdata=tail(dat.s%>%
  dplyr::select(all_of(select.cols.little))%>%
  na.omit(), 2))

pca.data<- as.data.frame(pca.f$x)

pca.data$species <- pca.cols.to.add$taxon_name
pca.data$sex <- pca.cols.to.add$sex


g<-ggplot(pca.data, aes(x=PC1, y=PC2, fill = species))+
  geom_point(shape=21, size=3)+
  stat_ellipse()+ #default is 0.95 and type t which assumes a multivariate t distribution
  scale_fill_crane("cranes")+
  theme(legend.position = "top")
g

ggsave(g +theme(), filename = paste0(figures,"Crane_wing_bill_tarsus_tail_PCA_conservative.pdf"), height = 4.6, width = 4.5, units = "in", device = cairo_pdf)
```


```{r}
g<-ggplot(pca.data, aes(x=PC1, y=PC2, fill = sex))+
  geom_point(shape=21, size=2)+
  stat_ellipse()+
  facet_wrap(.~species)+
  scale_fill_sex("cranes")+
  theme(legend.position = "top")
g

ggsave(g +theme(), filename = paste0(figures,"Crane_wing_bill_tarsus_PCA_sex_conservative.pdf"), height = 3.2, width = 4.5, units = "in", device = cairo_pdf)

```

### Biplot
greaters 
```{r, `greaterOnlyPCA`}

pca.cols.to.add <-dat.s%>%
  filter(taxon_name=="Antigone canadensis tabida")%>%
  dplyr::select(all_of(select.cols.big))%>%
  na.omit()%>%
  dplyr::select(1:3)

pca.f<-dat.s%>%
  filter(taxon_name=="Antigone canadensis tabida")%>%
  dplyr::select(all_of(select.cols.little))%>%
  na.omit()%>%
  prcomp(., center=T,
         scale=T)

print(pca.f)
plot(pca.f, type = "l")
summary(pca.f)

```

```{r `greaterBiplot`}

p<-ggplot_pca(pca.f,
           fill=as.character(pca.cols.to.add$sex),
           groups = pca.cols.to.add%>%dplyr::select(sex)%>% mutate(sex = as.character(sex))%>%pull(),
           ellipse = T)
p 

ggsave(p +theme(), filename = paste0(figures,"Greater_wing_bill_tarsus_tail_PCA_biplot_sex_conservative.pdf"), height = 3.2, width = 4.5, units = "in", device = cairo_pdf)
```

lesser
```{r, `lesserOnlyPCA`}

pca.cols.to.add <-dat.s%>%
  filter(taxon_name=="Antigone canadensis canadensis")%>%
  dplyr::select(all_of(select.cols.big))%>%
  na.omit()%>%
  dplyr::select(1:3)

pca.f<-dat.s%>%
  filter(taxon_name=="Antigone canadensis canadensis")%>%
  dplyr::select(all_of(select.cols.little))%>%
  na.omit()%>%
  prcomp(., center=T,
         scale=T)

print(pca.f)
plot(pca.f, type = "l")
summary(pca.f)

```

```{r `lesserBiplot`}

p<-ggplot_pca(pca.f,
           fill=as.character(pca.cols.to.add$sex),
           groups = pca.cols.to.add%>%dplyr::select(sex)%>% mutate(sex = as.character(sex))%>%pull(),
           ellipse = T)
p 

ggsave(p +theme(), filename = paste0(figures,"Lesser_wing_bill_tarsus_tail_PCA_biplot_sex_conservative.pdf"), height = 3.2, width = 4.5, units = "in", device = cairo_pdf)
```

### Euclidean and Manhattan Distances Between sexes
greaters
```{r}
pca.cols.to.add <-dat.s%>%
  filter(taxon_name == "Antigone canadensis tabida")%>%
  dplyr::select(all_of(select.cols.big))%>%
  na.omit()%>%
  dplyr::select(1:3)

pca.f<-dat.s%>%
  filter(taxon_name == "Antigone canadensis tabida")%>%
  dplyr::select(all_of(select.cols.little))%>%
  na.omit()%>%
  prcomp(., center=T,
         scale=T)

pca.data<- as.data.frame(pca.f$x)

pca.data$species <- pca.cols.to.add$taxon_name
pca.data$sex <- pca.cols.to.add$sex
pca.data$mass <- pca.cols.to.add$mass
pca.data$log_mass.z <- scale(log10(pca.cols.to.add$mass))

 
#find distances between greater sexes

pca.centroids <- aggregate(pca.data[,1:4], list(Type = pca.data$sex), mean)

#euclidean
dist(rbind(pca.centroids[pca.centroids$Type == "M",2:3],pca.centroids[pca.centroids$Type == "F",2:3]), method = "euclidean")

#manhattan
dist(rbind(pca.centroids[pca.centroids$Type == "M",2:3],pca.centroids[pca.centroids$Type == "F",2:3]), method = "manhattan")



#now bind PC1 and d.ev.else to get baysian modeling dataframe
greater.wbtt.pc <- pca.data

```

lessers
```{r}
pca.cols.to.add <-dat.s%>%
  filter(taxon_name == "Antigone canadensis canadensis")%>%
  dplyr::select(all_of(select.cols.big))%>%
  na.omit()%>%
  dplyr::select(1:3)

pca.f<-dat.s%>%
  filter(taxon_name == "Antigone canadensis canadensis")%>%
  dplyr::select(all_of(select.cols.little))%>%
  na.omit()%>%
  prcomp(., center=T,
         scale=T)

pca.data<- as.data.frame(pca.f$x)

pca.data$species <- pca.cols.to.add$taxon_name
pca.data$sex <- pca.cols.to.add$sex
pca.data$mass <- pca.cols.to.add$mass
pca.data$log_mass.z <- scale(log10(pca.cols.to.add$mass))
 
#find distances between greater sexes

pca.centroids <- aggregate(pca.data[,1:4], list(Type = pca.data$sex), mean)

#euclidean
dist(rbind(pca.centroids[pca.centroids$Type == "M",2:3],pca.centroids[pca.centroids$Type == "F",2:3]), method = "euclidean")

#manhattan
dist(rbind(pca.centroids[pca.centroids$Type == "M",2:3],pca.centroids[pca.centroids$Type == "F",2:3]), method = "manhattan")

#now bind PC1 and d.ev.else to get baysian modeling dataframe
lesser.wbtt.pc <- pca.data

```


# Regression Residuals \~ segment width + segment count

```{r}
hist(dat.g$r)
hist(dat.l$r)

l.m.r.seg <- lm(r ~ segment_count.z + segment_width.z, data=dat.l%>%filter(sex=="M"))

l.m.r.seg

l.f.r.seg <- lm(r ~ segment_count.z + segment_width.z, data=dat.l%>%filter(sex=="F"))

l.f.r.seg

g.m.r.seg <- lm(r ~ segment_count.z + segment_width.z, data=dat.g%>%filter(sex=="M"))

g.m.r.seg

g.f.r.seg <- lm(r ~ segment_count.z + segment_width.z, data=dat.g%>%filter(sex=="F"))

g.f.r.seg

seg.index.l.m <-l.m.r.seg$coefficients[2]/
 (l.m.r.seg$coefficients[2] +l.m.r.seg$coefficients[3])
seg.index.l.m

seg.index.l.f <-l.f.r.seg$coefficients[2]/
 (l.f.r.seg$coefficients[2] +l.f.r.seg$coefficients[3])
seg.index.l.f


seg.index.g.m <-g.m.r.seg$coefficients[2]/
 (g.m.r.seg$coefficients[2] +g.m.r.seg$coefficients[3])
seg.index.g.m

seg.index.l.f <-g.f.r.seg$coefficients[2]/
 (g.f.r.seg$coefficients[2] + g.f.r.seg$coefficients[3])
seg.index.l.f
```


# Models

## MTL ~ Mass

Here we can run the models from custom functions in the model_runner.R file. The functions in the file produce a list of model outputs and a LOO model comparison object. We have set weakly informative priors that are included in the functions. Both use the `brmsfamily` *skew_normal*.

```{R `runMTLmodels`}

source("functions/model_runners.R")

#dat.g <- dat.g%>%
#  filter(bursa %in% c("N", "N "))

#run models
# run_my_mtl_models(dat.g, "greater_mtl_models", seed=6)
# run_my_mtl_models(dat.l, "lesser_mtl_models", seed=6)
# 
# save(greater_mtl_models, file=paste0(models, "greater_mtl_models.Rdata"))
# save(lesser_mtl_models, file=paste0(models, "lesser_mtl_models.Rdata"))

load(file=paste0(models, "greater_mtl_models.Rdata"))
load(file=paste0(models, "lesser_mtl_models.Rdata"))
```

### Examine model fit
### Rhat ESS

First look at Rhat values, ESS (n_eff), and parameter estimates.
Greaters first
```{r}
greater_mtl_models[[3]][[1]][["fit"]]
greater_mtl_models[[3]][[2]][["fit"]]
greater_mtl_models[[3]][[3]][["fit"]]
greater_mtl_models[[3]][[4]][["fit"]]
greater_mtl_models[[3]][[5]][["fit"]]


```
No R hat over 1 and acceptable ESS.


Lessers
```{r}
lesser_mtl_models[[3]][[1]][["fit"]]
lesser_mtl_models[[3]][[2]][["fit"]]
lesser_mtl_models[[3]][[3]][["fit"]]
lesser_mtl_models[[3]][[4]][["fit"]]
lesser_mtl_models[[3]][[5]][["fit"]]


```
No R hat over 1 and acceptable ESS.

### PP checks
Greaters
Null: log10(mtl) ~ 1
```{r, `greaterMTLppcheck`, figures-side, fig.show="hold", out.width="33%"}

color_scheme_set(scheme = "darkgray")
pp_check(greater_mtl_models[[3]][[1]], ndraws = 100) 
pp_check(greater_mtl_models[[3]][[1]], type = "stat", stat = 'median', ndraws = 2000)
pp_check(greater_mtl_models[[3]][[1]], type = "stat", stat = 'mean', ndraws = 2000)

```

Two-term additive: log10(mtl) ~ log10(mass)
```{r, `greaterMTLppcheck`, figures-side, fig.show="hold", out.width="33%"}

color_scheme_set(scheme = "darkgray")
pp_check(greater_mtl_models[[3]][[2]], ndraws = 100) 
pp_check(greater_mtl_models[[3]][[2]], type = "stat", stat = 'median', ndraws = 2000)
pp_check(greater_mtl_models[[3]][[2]], type = "stat", stat = 'mean', ndraws = 2000)

```

Full additive: log10(mtl) ~ sex
```{r, `greaterMTLppcheck`, figures-side, fig.show="hold", out.width="33%"}

color_scheme_set(scheme = "darkgray")
pp_check(greater_mtl_models[[3]][[3]], ndraws = 100) 
pp_check(greater_mtl_models[[3]][[3]], type = "stat", stat = 'median', ndraws = 2000)
pp_check(greater_mtl_models[[3]][[3]], type = "stat", stat = 'mean', ndraws = 2000)

```

Full Additive: mtl ~ mass + sex
```{r, `greaterMTLppcheck`, figures-side, fig.show="hold", out.width="33%"}

color_scheme_set(scheme = "darkgray")
pp_check(greater_mtl_models[[3]][[4]], ndraws = 100) 
pp_check(greater_mtl_models[[3]][[4]], type = "stat", stat = 'median', ndraws = 2000)
pp_check(greater_mtl_models[[3]][[4]], type = "stat", stat = 'mean', ndraws = 2000)

```

Interaction: log10(mtl) ~ log10(mass) x sex
```{r, `greaterMTLppcheck`, figures-side, fig.show="hold", out.width="33%"}

color_scheme_set(scheme = "darkgray")
pp_check(greater_mtl_models[[3]][[5]], ndraws = 100) 
pp_check(greater_mtl_models[[3]][[5]], type = "stat", stat = 'median', ndraws = 2000)
pp_check(greater_mtl_models[[3]][[5]], type = "stat", stat = 'mean', ndraws = 2000)

```

Lessers
Null: log10(mtl) ~ 1
```{r, `lesserMTLppcheck`, figures-side, fig.show="hold", out.width="33%"}

color_scheme_set(scheme = "darkgray")
pp_check(lesser_mtl_models[[3]][[1]], ndraws = 100) 
pp_check(lesser_mtl_models[[3]][[1]], type = "stat", stat = 'median', ndraws = 2000)
pp_check(lesser_mtl_models[[3]][[1]], type = "stat", stat = 'mean', ndraws = 2000)

```

Two-term additive: log10(mtl) ~ log10(mass)
```{r, `lesserMTLppcheck`, figures-side, fig.show="hold", out.width="33%"}

color_scheme_set(scheme = "darkgray")
pp_check(lesser_mtl_models[[3]][[2]], ndraws = 100) 
pp_check(lesser_mtl_models[[3]][[2]], type = "stat", stat = 'median', ndraws = 2000)
pp_check(lesser_mtl_models[[3]][[2]], type = "stat", stat = 'mean', ndraws = 2000)

```

Catagorical additive: log10(mtl) ~  sex
```{r, `lesserMTLppcheck`, figures-side, fig.show="hold", out.width="33%"}

color_scheme_set(scheme = "darkgray")
pp_check(lesser_mtl_models[[3]][[3]], ndraws = 100) 
pp_check(lesser_mtl_models[[3]][[3]], type = "stat", stat = 'median', ndraws = 2000)
pp_check(lesser_mtl_models[[3]][[3]], type = "stat", stat = 'mean', ndraws = 2000)

```

Full additive: log10(mtl) ~ log10(mass) + sex
```{r, `lesserMTLppcheck`, figures-side, fig.show="hold", out.width="33%"}

color_scheme_set(scheme = "darkgray")
pp_check(lesser_mtl_models[[3]][[4]], ndraws = 100) 
pp_check(lesser_mtl_models[[3]][[4]], type = "stat", stat = 'median', ndraws = 2000)
pp_check(lesser_mtl_models[[3]][[4]], type = "stat", stat = 'mean', ndraws = 2000)

```

Interaction: log10(mtl) ~ +log10(mass) + sex + log10(mass) x sex
```{r, `lesserMTLppcheck`, figures-side, fig.show="hold", out.width="33%"}

color_scheme_set(scheme = "darkgray")
pp_check(lesser_mtl_models[[3]][[5]], ndraws = 100) 
pp_check(lesser_mtl_models[[3]][[5]], type = "stat", stat = 'median', ndraws = 2000)
pp_check(lesser_mtl_models[[3]][[5]], type = "stat", stat = 'mean', ndraws = 2000)

```

### Model comparison
greaters
```{r}

greater_mtl_models[[3]][[6]]

```
Interaction model is top supported model clearly.

Bayes R^2
```{r}

greater_mtl_models[[3]][[7]][[1]]
greater_mtl_models[[3]][[7]][[2]]
greater_mtl_models[[3]][[7]][[3]]
greater_mtl_models[[3]][[7]][[4]]
greater_mtl_models[[3]][[7]][[5]]

```

lessers
LOOIC
```{r}

lesser_mtl_models[[3]][[6]]

```
Full additive model (F4) is best for lessers, though interaction model is close and is AIC rules apply for elpd then they are equivalent but so is catagorical.


Bayes R^2
```{r}

lesser_mtl_models[[3]][[7]][[1]]
lesser_mtl_models[[3]][[7]][[2]]
lesser_mtl_models[[3]][[7]][[3]]
lesser_mtl_models[[3]][[7]][[4]]
lesser_mtl_models[[3]][[7]][[5]]

```

### Plotting
### Conditional effects
Here we plot conditional effects from best model for greaters
```{r, `conEffectGreater`, figures-side, fig.show="hold", out.width="50%"}
ce1 <- conditional_effects(greater_mtl_models[[3]][[5]])

p <- ggplot(ce1$log_mass.z, aes(log_mass.z, estimate__))+
  geom_ribbon(aes(ymin=lower__, ymax=upper__), fill="grey")+
  geom_line(color="black", linetype="dashed")+
  labs( x=expression(log["10"](mass~(g))), y=expression(log["10"]("mean trachea length (mm)")))
p
ggsave(p +theme(), filename = paste0(figures,"Greater_cond_eff_mtl-mass_conservative.pdf"), height = 4, width = 4.6, units = "in", device = cairo_pdf)


p1 <- ggplot(ce1$`log_mass.z:sex`, aes(log_mass.z, estimate__, fill=sex))+
  geom_ribbon(aes(ymin=lower__, ymax=upper__), alpha=0.5)+
  geom_line(color="black", linetype="dashed")+
  scale_fill_sex("cranes")+
  labs( x=expression(log["10"](mass~(g))), y=expression(log["10"]("mean trachea length (mm)")))
p1
ggsave(p1 +theme(), filename = paste0(figures,"Greater_cond_eff_mtl-mass-int-sex_conservative.pdf"), height = 4, width = 4.6, units = "in", device = cairo_pdf)

```

lessers
```{r, `conEffectLesser`, figures-side, fig.show="hold", out.width="50%"}
#HERE WE USE the Interaction model just of examine basically equivalent models
ce <- conditional_effects(lesser_mtl_models[[3]][[5]])

p <- ggplot(ce$log_mass.z, aes(log_mass.z, estimate__, group=sex))+
  geom_ribbon(aes(ymin=lower__, ymax=upper__), fill="grey")+
  geom_line(color="black", linetype="dashed")+
  labs( x=expression(log["10"](mass~(g))), y=expression(log["10"]("mean trachea length (mm)")))
p
ggsave(p +theme(), filename = paste0(figures,"Lesser_cond_eff_mtl-mass_conservative.pdf"), height = 4, width = 4.6, units = "in", device = cairo_pdf)

p1 <- ggplot(ce$`log_mass.z:sex`, aes(log_mass.z, estimate__, fill=sex))+
  geom_ribbon(aes(ymin=lower__, ymax=upper__), alpha=0.5)+
  geom_line(color="black", linetype="dashed")+
  scale_fill_sex("cranes")+
  labs( x=expression(log["10"](mass~(g))), y=expression(log["10"]("mean trachea length (mm)")))
p1
ggsave(p1 +theme(), filename = paste0(figures,"Lesser_cond_eff_mtl-mass-int-sex_conservative.pdf"), height = 4, width = 4.6, units = "in", device = cairo_pdf)

```

```{r}
p1 <- ggplot()+
  geom_line(data=ce$log_mass.z, aes(log_mass.z, estimate__),color="black", linetype="dashed")+
  geom_ribbon(data=ce$log_mass.z, aes(x=log_mass.z, ymin=lower__, ymax=upper__), alpha=0.5, fill="seashell3")+
  geom_line(data=ce1$log_mass.z, aes(log_mass.z, estimate__),color="black", linetype="dashed")+
  geom_ribbon(data=ce1$log_mass.z, aes(x=log_mass.z, ymin=lower__, ymax=upper__), alpha=0.5, fill="#A62800")+
  labs( x=expression(log["10"](mass~(g))), y=expression(log["10"]("mean trachea length (mm)")))
p1
ggsave(p1 +theme(), filename = paste0(figures,"Greater-and_lesser_cond_eff_mtl-mass_conservative.pdf"), height = 4, width = 4.6, units = "in", device = cairo_pdf)
#greater red here lesser grey


```

### Posterior Predictions and Contrasts

greaters

Since we want to make relevant comparisons and interactions are essentially uninterperatable in this context and likely attributed to small samples size we will use the additive model for greaters which is essentially [equivalent by LOOIC](https://discourse.mc-stan.org/t/interpreting-elpd-diff-loo-package/1628).
```{r}
newdata <-dat.g%>%dplyr::select(sex, log_mtl, log_mass.z)%>%filter(!sex %in% c("UNKNOWN"))%>%droplevels()

tidy_pred <- greater_mtl_models[[3]][[5]] %>% 
  epred_draws(newdata = newdata , ndraws = 50)

#get min value for males 
min_mass_males <- tidy_pred%>%
  filter(sex=="M")%>%
  group_by(sex)%>%
  summarise(min_mass_males = min(log_mass.z))%>%
  pull()

#epred off that value
#set up newdataframe
newdata  <- expand_grid(sex = c("M", "F"),
                       log_mass.z = c(min_mass_males))
  

#draw expected values from posterior: this is more of a population estimate (smaller associated error)

tidy_pred <- greater_mtl_models[[3]][[5]] %>% 
  epred_draws(newdata = newdata)
tidy_pred

#find difference between each "pair of values
library(dplyr)
M.pred <- tidy_pred%>%
  filter(sex=="M")

F.pred <- tidy_pred%>%
  filter(sex=="F")

SDI.pred.g <- (M.pred$.epred -F.pred$.epred)/F.pred$.epred



newdata.f <-dat.g %>%
  group_by(sex="F") %>%
  droplevels()%>% #drop unused but present unknown level
  data_grid(log_mass.z = seq(from=min(dat.g[,"log_mass.z"]), to=max(dat.g[,"log_mass.z"]), len= 50))

tidy_pred.f <- greater_mtl_models[[3]][[5]] %>% 
  epred_draws(newdata = newdata.f )


newdata.m <-dat.g %>%
  group_by(sex="M") %>%
  droplevels()%>% #drop unused but present unknown level
  data_grid(log_mass.z = seq(from=min(dat.g[,"log_mass.z"]), to=max(dat.g[,"log_mass.z"]), len= 50))

tidy_pred.m <- greater_mtl_models[[3]][[5]] %>% 
  epred_draws(newdata = newdata.m )

tidy.pred.contrasts.g <-
  data.frame(
    contrast = (tidy_pred.m$.epred - tidy_pred.f$.epred),
    SDI = (tidy_pred.m$.epred - tidy_pred.f$.epred) /
      tidy_pred.f$.epred,
    log_mass.z = tidy_pred.f$log_mass.z
  )

p<-tidy.pred.contrasts.g%>%
  ggplot(., aes(log_mass.z, contrast))+
  stat_ribbon(alpha=0.6, .width = c(0.5, 0.6, 0.7, 0.8, 0.9))+
  scale_fill_brewer(palette = "Greys")+
  scale_color_brewer(palette = "Greys")+
  geom_hline(yintercept = 0, linetype="dashed")+
  annotate("rect", xmin = -1.07444071, xmax = 0.7948448308, ymin = -Inf, ymax =  Inf,
           alpha = .1,fill = "blue")+
  labs(x=expression(paste("standardized(log"["10"], "mass)", sep="")), y="tracheal length contrast (M-F)")+
  scale_y_continuous(limits = c(-0.08, 0.1))
p
ggsave(p, filename=paste(figures, "greater_trachea_contrasts_by_weight_conservative_interaction.pdf", sep=""), width=4.7, height=3.5, device=cairo_pdf)


p<-tidy.pred.contrasts.g%>%
  ggplot(., aes(log_mass.z, SDI))+
  stat_ribbon(alpha=0.6, .width = c(0.5, 0.6, 0.7, 0.8, 0.9))+
  scale_fill_brewer(palette = "Greys")+
  scale_color_brewer(palette = "Greys")+
  geom_hline(yintercept = 0, linetype="dashed")+
  annotate("rect", xmin = -1.07444071, xmax = 0.7948448308, ymin = -Inf, ymax =  Inf,
           alpha = .1,fill = "blue")+
  labs(x=expression(paste("standardized(log"["10"], "mass)", sep="")), y=expression(paste("SDI"["tracheal length"])))+
  scale_y_continuous(limits = c(-0.02, 0.05))
p
ggsave(p, filename=paste(figures, "greater_SDI_contrasts_by_weight_conservative_interaction.pdf", sep=""), width=4.7, height=3.5, device=cairo_pdf)
```

lessers

```{r}

newdata <-dat.l%>%dplyr::select(sex, log_mtl, log_mass.z)%>%filter(!sex %in% c("UNKNOWN"))%>%droplevels()

tidy_pred <- lesser_mtl_models[[3]][[5]] %>% 
  epred_draws(newdata = newdata , ndraws=50)

#get min value for males 
min_mass_males <- tidy_pred%>%
  filter(sex=="M")%>%
  group_by(sex)%>%
  dplyr::summarise(min_mass_males = min(log_mass.z))%>%
  pull()

#pred off that value
#set up newdataframe
newdata  <- expand_grid(sex = c("M", "F"),
                       log_mass.z = c(min_mass_males))
  

#draw expected values from posterior: this is more of a population estimate (smaller associated error)

tidy_pred <- lesser_mtl_models[[3]][[5]] %>% 
  epred_draws(newdata = newdata )
tidy_pred

#find difference between each "pair of values
library(dplyr)
M.pred <- tidy_pred%>%
  filter(sex=="M")

F.pred <- tidy_pred%>%
  filter(sex=="F")

SDI.pred.l <- (M.pred$.epred -F.pred$.epred)/F.pred$.epred #original way chris suggested same as lovich and gibbons 1992 different formula terms


newdata.f <-dat.l %>%
  group_by(sex="F") %>%
  droplevels()%>% #drop unused but present unknown level
  data_grid(log_mass.z = seq(from=min(dat.l[,"log_mass.z"]), to=max(dat.l[,"log_mass.z"]), len= 50))

tidy_pred.f <- lesser_mtl_models[[3]][[5]] %>% 
  epred_draws(newdata = newdata.f )


newdata.m <-dat.l %>%
  group_by(sex="M") %>%
  droplevels()%>% #drop unused but present unknown level
  data_grid(log_mass.z = seq(from=min(dat.l[,"log_mass.z"]), to=max(dat.l[,"log_mass.z"]), len= 50))

tidy_pred.m <- lesser_mtl_models[[3]][[5]] %>% 
  epred_draws(newdata = newdata.m )

tidy.pred.contrasts.l <- data.frame(contrast = tidy_pred.m$.epred - tidy_pred.f$.epred,
                                  SDI = (tidy_pred.m$.epred - tidy_pred.f$.epred)/tidy_pred.f$.epred,
                                  log_mass.z = tidy_pred.f$log_mass.z)

p<-tidy.pred.contrasts.l%>%
  ggplot(., aes(log_mass.z, contrast))+
  stat_ribbon(alpha=0.6, .width = c(0.5, 0.6, 0.7, 0.8, 0.9))+
  scale_fill_brewer(palette = "Greys")+
  scale_color_brewer(palette = "Greys")+
  geom_hline(yintercept = 0, linetype="dashed")+
  annotate("rect", xmin = -0.181921793
, xmax = 0.83078782, ymin = -Inf, ymax =  Inf,
           alpha = .1,fill = "blue")+
  labs(x=expression(paste("standardized(log"["10"], "mass)", sep="")), y="tracheal length contrast (M-F)")+
  scale_y_continuous(limits = c(-0.08, 0.1))
p
ggsave(p, filename=paste(figures, "lesser_raw_trachea_contrasts_by_weight_interaction_conservative.pdf", sep=""), width=4.7, height=3.5, device=cairo_pdf)

p<-tidy.pred.contrasts.l%>%
  ggplot(., aes(log_mass.z, SDI))+
  annotate("rect", xmin = -0.181921793
, xmax = 0.83078782, ymin = -Inf, ymax =  Inf,
           alpha = .3,fill = "grey")+
  annotate("rect", xmin = -1.07444071, xmax = 0.7948448308, ymin = -Inf, ymax =  Inf,
           alpha = .2,fill = "darkred")+
  stat_ribbon(alpha=0.6, .width = c(0.5, 0.6, 0.7, 0.8, 0.9))+
  stat_ribbon(data=tidy.pred.contrasts.g, aes(log_mass.z, SDI), alpha=0.4, .width = c(0.5, 0.6, 0.7, 0.8, 0.9), fill="darkred")+
  scale_fill_brewer(palette = "Greys")+
  scale_color_brewer(palette = "Greys")+
  geom_hline(yintercept = 0, linetype="dashed")+
  
  labs(x=expression(paste("standardized(log"["10"], "mass)", sep="")), y=expression(paste("SDI"["tracheal length"])))+
  scale_y_continuous(limits = c(-0.001, 0.02))
p
ggsave(p+ theme(), filename=paste(figures, "Greater &lesser_SDI_by_weight_interaction_models_conservative.pdf", sep=""), width=4.9, height=3.5, device=cairo_pdf)

```

### SDI-mtl plot

```{r, echo=F}

SDI.plot <- data.frame(x=tidy.pred.contrasts.g$SDI, Taxon="greater")
SDI.plot <- rbind(SDI.plot, data.frame(x=tidy.pred.contrasts.l$SDI, Taxon="lesser"))
SDI.plot%>%
  group_by(Taxon)%>%
  summarise(median = median(x),
            mean= mean(x),
            se = std.error(x),
            lower95CI = quantile(x, probs=c(0.025)),
            upper95CI = quantile(x, probs=c(0.975)))

p<-ggplot(SDI.plot, aes(x=x,y=Taxon, fill=Taxon))+
  geom_vline(xintercept = 0, linetype="dashed", alpha=0.3)+
  stat_halfeye(alpha=0.7)+
  #scale_fill_manual(values=c("dodgerblue2", "darkorchid1"))+
  theme(legend.title = element_blank(),
        legend.position = "none")+
  scale_fill_crane("cranes")+
  labs(x=expression(paste("SDI"[italic("trachea")])), y="")
p
ggsave(p, filename = paste0(figures, "SDI_PP_trachea_grey_additive_conservative.pdf"), width=5, height=4, device = cairo_pdf)

```

```{r, `cohenD`}

cohen.d(SDI.pred.l, SDI.pred.g)
# Cohen's d
# 
# d estimate: 2.906798 (large)
# 95 percent confidence interval:
#    lower    upper 
# 2.817897 2.995700 
```

## Mass ~ sex

```{r, `runMassModels`}
source("functions/model_runners.R")

#dat.g <- dat.g%>%
#  filter(bursa %in% c("N", "N "))

#run models
# run_my_mass_models(dat.g, "greater_mass_models", seed=6)
# run_my_mass_models(dat.l, "lesser_mass_models", seed=6)
# 
# save(greater_mass_models, file=paste0(models, "greater_mass_models.Rdata"))
# save(lesser_mass_models, file=paste0(models, "lesser_mass_models.Rdata"))

load(file=paste0(models, "greater_mass_models.Rdata"))
load(file=paste0(models, "lesser_mass_models.Rdata"))

```

### Examine model fit
### Rhat ESS

First look at Rhat values, ESS (n_eff), and parameter estimates.
Greaters first
```{r}
greater_mass_models[[3]][[1]][["fit"]]
greater_mass_models[[3]][[2]][["fit"]]
greater_mass_models[[3]][[3]][["fit"]]

```
No R hat over 1 and acceptable ESS.


Lessers
```{r}
lesser_mass_models[[3]][[1]][["fit"]]
lesser_mass_models[[3]][[2]][["fit"]]
lesser_mass_models[[3]][[3]][["fit"]]
```
No R hat over 1 and acceptable ESS.

### PP checks
Greaters
Null: log10(mass) ~ 1
```{r, `greaterMassppcheck`, figures-side, fig.show="hold", out.width="33%"}

color_scheme_set(scheme = "darkgray")
pp_check(greater_mass_models[[3]][[1]], ndraws = 100) 
pp_check(greater_mass_models[[3]][[1]], type = "stat", stat = 'median', ndraws = 2000)
pp_check(greater_mass_models[[3]][[1]], type = "stat", stat = 'mean', ndraws = 2000)

```

Two-term additive: log10(mass) ~ sex
```{r, `greaterMassppcheck`, figures-side, fig.show="hold", out.width="33%"}

color_scheme_set(scheme = "darkgray")
pp_check(greater_mass_models[[3]][[2]], ndraws = 100) 
pp_check(greater_mass_models[[3]][[2]], type = "stat", stat = 'median', ndraws = 2000)
pp_check(greater_mass_models[[3]][[2]], type = "stat", stat = 'mean', ndraws = 2000)

```

Full additive distributional: log10(mass) ~ sex, sigma ~ sex
```{r, `greaterMassppcheck`, figures-side, fig.show="hold", out.width="33%"}

color_scheme_set(scheme = "darkgray")
pp_check(greater_mass_models[[3]][[3]], ndraws = 100) 
pp_check(greater_mass_models[[3]][[3]], type = "stat", stat = 'median', ndraws = 2000)
pp_check(greater_mass_models[[3]][[3]], type = "stat", stat = 'mean', ndraws = 2000)

```



Lessers
Null: log10(mass) ~ 1
```{r, `lesserMassppcheck`, figures-side, fig.show="hold", out.width="33%"}

color_scheme_set(scheme = "darkgray")
pp_check(lesser_mass_models[[3]][[1]], ndraws = 100) 
pp_check(lesser_mass_models[[3]][[1]], type = "stat", stat = 'median', ndraws = 2000)
pp_check(lesser_mass_models[[3]][[1]], type = "stat", stat = 'mean', ndraws = 2000)

```

Two-term additive: log10(mass) ~ sex
```{r, `lesserMassppcheck`, figures-side, fig.show="hold", out.width="33%"}

color_scheme_set(scheme = "darkgray")
pp_check(lesser_mass_models[[3]][[2]], ndraws = 100) 
pp_check(lesser_mass_models[[3]][[2]], type = "stat", stat = 'median', ndraws = 2000)
pp_check(lesser_mass_models[[3]][[2]], type = "stat", stat = 'mean', ndraws = 2000)

```

Full additive distributional: log10(mass) ~ sex, sigma ~ sex
```{r, `lesserMassppcheck`, figures-side, fig.show="hold", out.width="33%"}

color_scheme_set(scheme = "darkgray")
pp_check(lesser_mass_models[[3]][[3]], ndraws = 100) 
pp_check(lesser_mass_models[[3]][[3]], type = "stat", stat = 'median', ndraws = 2000)
pp_check(lesser_mass_models[[3]][[3]], type = "stat", stat = 'mean', ndraws = 2000)

```

### Model comparison
```{r}

greater_mass_models[[3]][[4]]

```
simple and distributional are equivalent

Bayes R^2
```{r}

greater_mass_models[[3]][[5]][[1]]
greater_mass_models[[3]][[5]][[2]]
greater_mass_models[[3]][[5]][[3]]


```

LOOIC
```{r}

lesser_mass_models[[3]][[4]]

```
simple and distributional are equivalent


Bayes R^2
```{r}

lesser_mass_models[[3]][[5]][[1]]
lesser_mass_models[[3]][[5]][[2]]
lesser_mass_models[[3]][[5]][[3]]


```

### Plotting
### Conditional effects
Here we plot conditional effects from best model for greaters
```{r, `conEffectGreater`, figures-side, fig.show="hold", out.width="50%"}
ce <- conditional_effects(greater_mass_models[[3]][[2]])
ce <- as.data.frame(ce$sex)
p <- ggplot(ce, aes(sex, estimate__, fill=sex))+
  geom_pointrange(aes(ymin=lower__, ymax=upper__), shape=21, size=1.2)+
  scale_fill_sex("cranes")+
  labs( x=expression(log["10"](mass~(g))), y=expression(log["10"]("mean trachea length (mm)")))
p
ggsave(p +theme(), filename = paste0(figures,"Greater_cond_eff_mass_sex_conservative.pdf"), height = 4.6, width = 5.6, units = "in", device = cairo_pdf)


```

lessers
```{r, `conEffectLesser`, figures-side, fig.show="hold", out.width="50%"}
#HERE WE USE the Interaction model just of exmine basically equivalent models
ce <- conditional_effects(lesser_mass_models[[3]][[2]])
ce <- as.data.frame(ce$sex)
p <- ggplot(ce, aes(sex, estimate__, fill=sex))+
  geom_pointrange(aes(ymin=lower__, ymax=upper__), shape=21, size=1.2)+
  scale_fill_sex("cranes")+
  labs( x=expression(log["10"](mass~(g))), y=expression(log["10"]("mean trachea length (mm)")))
p
ggsave(p +theme(), filename = paste0(figures,"Lesser_cond_eff_mass-sex_conservative.pdf"), height = 4.6, width = 5.6, units = "in", device = cairo_pdf)

```

### Predicitons (top model)
lessers
```{r}
newdata <-dat.l%>%dplyr::select(sex, log_mass)%>%filter(!sex %in% c("UNKNOWN"))%>%droplevels()

tidy_pred <- lesser_mass_models[[3]][[2]] %>% 
  epred_draws(newdata = newdata )

#get median value for females 
tidy_mass_females <- tidy_pred%>%
  filter(sex=="F")%>%
  group_by(sex)

#get median value for males and sample to equal females
tidy_mass_males <- tidy_pred%>%
  filter(sex=="M")%>%
  group_by(sex)%>%
  sample_n(size=nrow(tidy_mass_females))


SDI.mass.pred.l.m <- (tidy_mass_males$.epred -tidy_mass_females$.epred)/tidy_mass_females$.epred


mean(SDI.mass.pred.l.m)
```


### Predicitons (top model)

```{r}
newdata <-dat.g%>%dplyr::select(sex, log_mass)%>%filter(!sex %in% c("UNKNOWN"))%>%droplevels()

tidy_pred <- greater_mass_models[[3]][[3]] %>% 
  epred_draws(newdata = newdata ) #change from exoected to posterior to get low or high spread. expected is mean from each posterior sample while posterior is just draw from posterior more like individual response, while expected is population response.


#get median value for females 
tidy_mass_females <- tidy_pred%>%
  filter(sex=="F")%>%
  group_by(sex)

#get median value for males 
tidy_mass_males <- tidy_pred%>%
  filter(sex=="M")%>%
  group_by(sex)%>%
  sample_n(size=nrow(tidy_mass_females))


SDI.mass.pred.g.m <- (tidy_mass_males$.epred -tidy_mass_females$.epred)/tidy_mass_females$.epred

SDI.mass.pred.g.m <- sample(SDI.mass.pred.g.m,size= length(SDI.mass.pred.l.m))

mean(SDI.mass.pred.g.m)
mean(SDI.mass.pred.l.m)
```

### SDI generated from Expected Predicted Posterior Draws (Mass) for catagorical model

```{r, echo=F}

SDI.m.plot <- data.frame(x=SDI.mass.pred.g.m, Taxon="greater")
SDI.m.plot <- rbind(SDI.m.plot, data.frame(x=SDI.mass.pred.l.m, Taxon="lesser"))
SDI.m.plot%>%
  group_by(Taxon)%>%
  summarise(median = median(x),
            mean= mean(x),
            se = std.error(x),
            lower95CI = quantile(x, probs=c(0.025)),
            upper95CI = quantile(x, probs=c(0.975)))

SDI.plot$cat <-"trachea"
SDI.m.plot$cat <-"mass"

SDI.plot <- rbind(SDI.plot, SDI.m.plot)

p<-SDI.plot%>%
  ggplot(., aes(x=x,y=Taxon, fill=Taxon))+
    stat_halfeye(alpha=0.5, point_alpha=0.8, interval_alpha=0.8)+
    #scale_fill_manual(values=c("cadetblue", "darkorchid3"))+
  #scale_color_manual(values=c("cadetblue4", "darkorchid4"))+
    theme(legend.title = element_blank(),
        legend.position = "none")+
  geom_vline(xintercept=0, linetype="dashed", color="grey")+
  scale_x_continuous(limits=c(-0.01, 0.03))+
  scale_fill_crane("cranes")+
    labs(x=expression(paste("SDI")), y="")+
  facet_wrap(.~cat)
p

ggsave(p, filename = paste0(figures, "SDI_cat_faceted_conservative.pdf"), width=7, height=3.5, device=cairo_pdf)

cohen.d(SDI.mass.pred.g.m, SDI.mass.pred.l.m)

# d estimate: -0.9040698 (large)
# 95 percent confidence interval:
#      lower      upper 
# -0.9114374 -0.8967022 

SDI_contrasts_plot <- data.frame(SDI.t = SDI.pred.l -SDI.pred.g,
                                 SDI.m = SDI.mass.pred.l.m - SDI.mass.pred.g.m)

SDI_contrasts_plot <- gather(SDI_contrasts_plot)

p<-ggplot(SDI_contrasts_plot, aes(x=value,y=key, fill=key))+
    stat_halfeye(fill="grey55")+
    theme_classic(base_size = 14)+
    #scale_fill_manual(values=c("dodgerblue2", "darkorchid1"))+
    theme(legend.title = element_blank(),
        legend.position = "none")+
    labs(x="contrasts SDI", y="")
p

ggsave(p, filename = paste(getwd(), "/figures/", "SDI_contrasts_grey_conservative.pdf", sep=""), width=6, height=5, device=cairo_pdf)


```

## PCA models



```{r, `PCAmodels`}

source("functions/model_runners.R")

pca.cols.to.add <-dat.s%>%
  dplyr::select(all_of(select.cols.big))%>%
  na.omit()%>%
  dplyr::select(1:3)

pca.f<-dat.s%>%
  dplyr::select(all_of(select.cols.little))%>%
  na.omit()%>%
  prcomp(., center=T,
         scale=T)

print(pca.f)
plot(pca.f, type = "l")
summary(pca.f)
predict(pca.f, 
        newdata=tail(dat.s%>%
  dplyr::select(all_of(select.cols.little))%>%
  na.omit(), 2))

pca.data<- as.data.frame(pca.f$x)

pca.data$species <- pca.cols.to.add$taxon_name
pca.data$sex <- pca.cols.to.add$sex
pca.data$mass <- pca.cols.to.add$mass
pca.data$log_mass.z <- scale(log10(pca.cols.to.add$mass))


#run models
# run_my_PC_models(data=pca.data, taxon = "Antigone canadensis tabida", name="greater_PC_models", seed=6)
# run_my_PC_models(pca.data, taxon = "Antigone canadensis canadensis",name="lesser_PC_models", seed=6)
# 
# save(greater_PC_models, file=paste0(models, "greater_PC_models.Rdata"))
# save(lesser_PC_models, file=paste0(models, "lesser_PC_models.Rdata"))

load(file=paste0(models, "greater_PC_models.Rdata"))
load(file=paste0(models, "lesser_PC_models.Rdata"))

```

### Examine model fit
### Rhat ESS

First look at Rhat values, ESS (n_eff), and parameter estimates.
Greaters first
```{r}
greater_PC_models[[3]][[1]][["fit"]]
greater_PC_models[[3]][[2]][["fit"]]
greater_PC_models[[3]][[3]][["fit"]]
greater_PC_models[[3]][[4]][["fit"]]
greater_PC_models[[3]][[5]][["fit"]]


```
No R hat over 1 and acceptable ESS.


Lessers
```{r}
lesser_PC_models[[3]][[1]][["fit"]]
lesser_PC_models[[3]][[2]][["fit"]]
lesser_PC_models[[3]][[3]][["fit"]]
lesser_PC_models[[3]][[4]][["fit"]]
lesser_PC_models[[3]][[5]][["fit"]]


```
No R hat over 1 and acceptable ESS.

### PP checks
Greaters
Null: PC1 ~ 1
```{r, `greaterMTLppcheck`, figures-side, fig.show="hold", out.width="33%"}

color_scheme_set(scheme = "darkgray")
pp_check(greater_PC_models[[3]][[1]], ndraws = 100) 
pp_check(greater_PC_models[[3]][[1]], type = "stat", stat = 'median', ndraws = 2000)
pp_check(greater_PC_models[[3]][[1]], type = "stat", stat = 'mean', ndraws = 2000)

```

Two-term additive: PC1 ~ log10(mass)
```{r, `greaterMTLppcheck`, figures-side, fig.show="hold", out.width="33%"}

color_scheme_set(scheme = "darkgray")
pp_check(greater_PC_models[[3]][[2]], ndraws = 100) 
pp_check(greater_PC_models[[3]][[2]], type = "stat", stat = 'median', ndraws = 2000)
pp_check(greater_PC_models[[3]][[2]], type = "stat", stat = 'mean', ndraws = 2000)

```

Full additive: PC1 ~ sex
```{r, `greaterMTLppcheck`, figures-side, fig.show="hold", out.width="33%"}

color_scheme_set(scheme = "darkgray")
pp_check(greater_PC_models[[3]][[3]], ndraws = 100) 
pp_check(greater_PC_models[[3]][[3]], type = "stat", stat = 'median', ndraws = 2000)
pp_check(greater_PC_models[[3]][[3]], type = "stat", stat = 'mean', ndraws = 2000)

```

Full Additive: mtl ~ mass + sex
```{r, `greaterMTLppcheck`, figures-side, fig.show="hold", out.width="33%"}

color_scheme_set(scheme = "darkgray")
pp_check(greater_PC_models[[3]][[4]], ndraws = 100) 
pp_check(greater_PC_models[[3]][[4]], type = "stat", stat = 'median', ndraws = 2000)
pp_check(greater_PC_models[[3]][[4]], type = "stat", stat = 'mean', ndraws = 2000)

```

Interaction: PC1 ~ log10(mass) x sex
```{r, `greaterMTLppcheck`, figures-side, fig.show="hold", out.width="33%"}

color_scheme_set(scheme = "darkgray")
pp_check(greater_PC_models[[3]][[5]], ndraws = 100) 
pp_check(greater_PC_models[[3]][[5]], type = "stat", stat = 'median', ndraws = 2000)
pp_check(greater_PC_models[[3]][[5]], type = "stat", stat = 'mean', ndraws = 2000)

```

Lessers
Null: PC1 ~ 1
```{r, `lesserMTLppcheck`, figures-side, fig.show="hold", out.width="33%"}

color_scheme_set(scheme = "darkgray")
pp_check(lesser_PC_models[[3]][[1]], ndraws = 100) 
pp_check(lesser_PC_models[[3]][[1]], type = "stat", stat = 'median', ndraws = 2000)
pp_check(lesser_PC_models[[3]][[1]], type = "stat", stat = 'mean', ndraws = 2000)

```

Two-term additive: PC1 ~ log10(mass)
```{r, `lesserMTLppcheck`, figures-side, fig.show="hold", out.width="33%"}

color_scheme_set(scheme = "darkgray")
pp_check(lesser_PC_models[[3]][[2]], ndraws = 100) 
pp_check(lesser_PC_models[[3]][[2]], type = "stat", stat = 'median', ndraws = 2000)
pp_check(lesser_PC_models[[3]][[2]], type = "stat", stat = 'mean', ndraws = 2000)

```

Catagorical additive: PC1 ~  sex
```{r, `lesserMTLppcheck`, figures-side, fig.show="hold", out.width="33%"}

color_scheme_set(scheme = "darkgray")
pp_check(lesser_PC_models[[3]][[3]], ndraws = 100) 
pp_check(lesser_PC_models[[3]][[3]], type = "stat", stat = 'median', ndraws = 2000)
pp_check(lesser_PC_models[[3]][[3]], type = "stat", stat = 'mean', ndraws = 2000)

```

Full additive: PC1 ~ log10(mass) + sex
```{r, `lesserMTLppcheck`, figures-side, fig.show="hold", out.width="33%"}

color_scheme_set(scheme = "darkgray")
pp_check(lesser_PC_models[[3]][[4]], ndraws = 100) 
pp_check(lesser_PC_models[[3]][[4]], type = "stat", stat = 'median', ndraws = 2000)
pp_check(lesser_PC_models[[3]][[4]], type = "stat", stat = 'mean', ndraws = 2000)

```

Interaction: PC1 ~ +log10(mass) + sex + log10(mass) x sex
```{r, `lesserMTLppcheck`, figures-side, fig.show="hold", out.width="33%"}

color_scheme_set(scheme = "darkgray")
pp_check(lesser_PC_models[[3]][[5]], ndraws = 100) 
pp_check(lesser_PC_models[[3]][[5]], type = "stat", stat = 'median', ndraws = 2000)
pp_check(lesser_PC_models[[3]][[5]], type = "stat", stat = 'mean', ndraws = 2000)

```

### Model comparison
greaters
```{r}

greater_PC_models[[3]][[6]]

```
Full addditive top supported /Interaction nearly equivalent.

Bayes R^2
```{r}

greater_PC_models[[3]][[7]][[1]]
greater_PC_models[[3]][[7]][[2]]
greater_PC_models[[3]][[7]][[3]]
greater_PC_models[[3]][[7]][[4]]
greater_PC_models[[3]][[7]][[5]]

```

lessers
LOOIC
```{r}

lesser_PC_models[[3]][[6]]

```
Simple additive PC1 ~ mass. But PC1~mass+sex is next.


Bayes R^2
```{r}

lesser_PC_models[[3]][[7]][[1]]
lesser_PC_models[[3]][[7]][[2]]
lesser_PC_models[[3]][[7]][[3]]
lesser_PC_models[[3]][[7]][[4]]
lesser_PC_models[[3]][[7]][[5]]

```

### Plotting
### Conditional effects
Here we plot conditional effects from best model for greaters
```{r, `conEffectGreater`, figures-side, fig.show="hold", out.width="50%"}
ce1 <- conditional_effects(greater_PC_models[[3]][[4]])

p <- ggplot(ce1$log_mass.z, aes(log_mass.z, estimate__))+
  geom_ribbon(aes(ymin=lower__, ymax=upper__), fill="grey")+
  geom_line(color="black", linetype="dashed")+
  labs( x=expression(log["10"](mass~(g))), y="trachea PC1")
p
ggsave(p +theme(), filename = paste0(figures,"Greater_cond_eff_trachea_PC1-mass_conservative.pdf"), height = 4, width = 4.6, units = "in", device = cairo_pdf)


# p1 <- ggplot(ce1$`log_mass.z:sex`, aes(log_mass.z, estimate__, fill=sex))+
#   geom_ribbon(aes(ymin=lower__, ymax=upper__), alpha=0.5)+
#   geom_line(color="black", linetype="dashed")+
#   scale_fill_sex("cranes")+
#   labs( x=expression(log["10"](mass~(g))), y="trachea PC1")
# p1
# ggsave(p1 +theme(), filename = paste0(figures,"Greater_cond_eff_mtl-mass-int-sex_conservative.pdf"), height = 4, width = 4.6, units = "in", device = cairo_pdf)

```

lessers
```{r, `conEffectLesser`, figures-side, fig.show="hold", out.width="50%"}
#HERE WE USE the Interaction model just of examine basically equivalent models
ce <- conditional_effects(lesser_PC_models[[3]][[2]])

p <- ggplot(ce$log_mass.z, aes(log_mass.z, estimate__))+
  geom_ribbon(aes(ymin=lower__, ymax=upper__), fill="grey")+
  geom_line(color="black", linetype="dashed")+
  labs( x=expression(log["10"](mass~(g))), y="trachea PC1")
p
ggsave(p +theme(), filename = paste0(figures,"Lesser_cond_eff_trachea_PC1-mass_conservative.pdf"), height = 4, width = 4.6, units = "in", device = cairo_pdf)

# p1 <- ggplot(ce$`log_mass.z:sex`, aes(log_mass.z, estimate__, fill=sex))+
#   geom_ribbon(aes(ymin=lower__, ymax=upper__), alpha=0.5)+
#   geom_line(color="black", linetype="dashed")+
#   scale_fill_sex("cranes")+
#   labs( x=expression(log["10"](mass~(g))), y="trachea PC1")
# p1
# ggsave(p1 +theme(), filename = paste0(figures,"Lesser_cond_eff_trachea_PC1-mass-int-sex_conservative.pdf"), height = 4, width = 4.6, units = "in", device = cairo_pdf)

```

```{r}
p1 <- ggplot()+
  geom_line(data=ce$log_mass.z, aes(log_mass.z, estimate__),color="black", linetype="dashed")+
  geom_ribbon(data=ce$log_mass.z, aes(x=log_mass.z, ymin=lower__, ymax=upper__), alpha=0.5, fill="seashell3")+
  geom_line(data=ce1$log_mass.z, aes(log_mass.z, estimate__),color="black", linetype="dashed")+
  geom_ribbon(data=ce1$log_mass.z, aes(x=log_mass.z, ymin=lower__, ymax=upper__), alpha=0.5, fill="#A62800")+
  labs( x=expression(log["10"](mass~(g))), y="trachea PC1")
p1
ggsave(p1 +theme(), filename = paste0(figures,"Greater-and_lesser_cond_eff_trachea_PC1-mass_conservative.pdf"), height = 4, width = 4.6, units = "in", device = cairo_pdf)
#greater red here lesser grey


```

### Posterior Predictions and Contrasts

greaters

Since we want to make relevant comparisons and interactions are essentially uninterperatable in this context and likely attributed to small samples size we will use the additive model for greaters which is essentially [equivalent by LOOIC](https://discourse.mc-stan.org/t/interpreting-elpd-diff-loo-package/1628).
```{r}
newdata <-pca.data%>%filter%>%dplyr::select(species, sex, PC1, log_mass.z)%>%filter(!sex %in% c("UNKNOWN"), species =="Antigone canadensis tabida")%>%droplevels()

tidy_pred <- greater_PC_models[[3]][[4]] %>% 
  epred_draws(newdata = newdata , ndraws = 50)

#get min value for males 
min_mass_males <- tidy_pred%>%
  filter(sex=="M")%>%
  group_by(sex)%>%
  summarise(min_mass_males = min(log_mass.z))%>%
  pull()

max_mass_females <- tidy_pred%>%
  filter(sex=="F")%>%
  group_by(sex)%>%
  summarise(min_mass_females = max(log_mass.z))%>%
  pull()



#epred off that value
#set up newdataframe
newdata  <- expand_grid(sex = c("M", "F"),
                       log_mass.z = c(min_mass_males))
  

#draw expected values from posterior: this is more of a population estimate (smaller associated error)

tidy_pred <- greater_PC_models[[3]][[4]] %>% 
  epred_draws(newdata = newdata)
tidy_pred

#find difference between each "pair of values
library(dplyr)
M.pred <- tidy_pred%>%
  filter(sex=="M")

F.pred <- tidy_pred%>%
  filter(sex=="F")

SDI.pred.g <- (M.pred$.epred -F.pred$.epred)/F.pred$.epred



newdata.f <-pca.data %>%
  filter(species =="Antigone canadensis tabida")%>%
  group_by(sex="F") %>%
  droplevels()%>% #drop unused but present unknown level
  data_grid(log_mass.z = seq(from=min(pca.data[,"log_mass.z"]), to=max(pca.data[,"log_mass.z"]), len= 50))

tidy_pred.f <- greater_PC_models[[3]][[4]] %>% 
  epred_draws(newdata = newdata.f )


newdata.m <-pca.data %>%
  filter(species =="Antigone canadensis tabida")%>%
  group_by(sex="M") %>%
  droplevels()%>% #drop unused but present unknown level
  data_grid(log_mass.z = seq(from=min(pca.data[,"log_mass.z"]), to=max(pca.data[,"log_mass.z"]), len= 50))

tidy_pred.m <- greater_PC_models[[3]][[4]] %>% 
  epred_draws(newdata = newdata.m )

tidy.pred.contrasts.g <-
  data.frame(
    contrast = (tidy_pred.m$.epred - tidy_pred.f$.epred),
    SDI = (tidy_pred.m$.epred - tidy_pred.f$.epred) /
      tidy_pred.f$.epred,
    log_mass.z = tidy_pred.f$log_mass.z
  )

p<-tidy.pred.contrasts.g%>%
  ggplot(., aes(log_mass.z, contrast))+
  stat_ribbon(alpha=0.6, .width = c(0.5, 0.6, 0.7, 0.8, 0.9))+
  scale_fill_brewer(palette = "Greys")+
  scale_color_brewer(palette = "Greys")+
  geom_hline(yintercept = 0, linetype="dashed")+
  annotate("rect", xmin = min_mass_males, xmax = max_mass_females, ymin = -Inf, ymax =  Inf,
           alpha = .1,fill = "blue")+
  labs(x=expression(paste("standardized(log"["10"], "mass)", sep="")), y="trachea PC1 contrast (M-F)")+
  scale_y_continuous(limits = c(-0.02, 0.1))
p
ggsave(p, filename=paste(figures, "greater_trachea_PC1_contrasts_by_weight_conservative_interaction.pdf", sep=""), width=4.7, height=3.5, device=cairo_pdf)


p<-tidy.pred.contrasts.g%>%
  ggplot(., aes(log_mass.z, SDI))+
  stat_ribbon(alpha=0.6, .width = c(0.5, 0.6, 0.7, 0.8, 0.9))+
  scale_fill_brewer(palette = "Greys")+
  scale_color_brewer(palette = "Greys")+
  geom_hline(yintercept = 0, linetype="dashed")+
  annotate("rect", xmin = min_mass_males, xmax = max_mass_females, ymin = -Inf, ymax =  Inf,
           alpha = .1,fill = "blue")+
  labs(x=expression(paste("standardized(log"["10"], "mass)", sep="")), y=expression(paste("SDI"["trachea PC1"])))+
  scale_y_continuous(limits = c(0, 0.08))
p
ggsave(p, filename=paste(figures, "greater_tracheaPC1_SDI_contrasts_by_weight_conservative_interaction.pdf", sep=""), width=4.7, height=3.5, device=cairo_pdf)
```
Incomprehensible.


lessers

```{r}
newdata <-pca.data%>%filter%>%dplyr::select(species, sex, PC1, log_mass.z)%>%filter(!sex %in% c("UNKNOWN"), species =="Antigone canadensis canadensis")%>%droplevels()

tidy_pred <- greater_PC_models[[3]][[2]] %>% 
  epred_draws(newdata = newdata , ndraws = 50)

#get min value for males 
min_mass_males <- tidy_pred%>%
  filter(sex=="M")%>%
  group_by(sex)%>%
  summarise(min_mass_males = min(log_mass.z))%>%
  pull()

max_mass_females <- tidy_pred%>%
  filter(sex=="F")%>%
  group_by(sex)%>%
  summarise(min_mass_females = max(log_mass.z))%>%
  pull()



#epred off that value
#set up newdataframe
newdata  <- expand_grid(sex = c("M", "F"),
                       log_mass.z = c(min_mass_males))
  

#draw expected values from posterior: this is more of a population estimate (smaller associated error)

tidy_pred <- greater_PC_models[[3]][[2]] %>% 
  epred_draws(newdata = newdata)
tidy_pred

#find difference between each "pair of values
library(dplyr)
M.pred <- tidy_pred%>%
  filter(sex=="M")

F.pred <- tidy_pred%>%
  filter(sex=="F")

SDI.pred.l <- (M.pred$.epred -F.pred$.epred)/F.pred$.epred



newdata.f <-pca.data %>%
  filter(species =="Antigone canadensis canadensis")%>%
  group_by(sex="F") %>%
  droplevels()%>% #drop unused but present unknown level
  data_grid(log_mass.z = seq(from=min(pca.data[,"log_mass.z"]), to=max(pca.data[,"log_mass.z"]), len= 50))

tidy_pred.f <- greater_PC_models[[3]][[4]] %>% 
  epred_draws(newdata = newdata.f )


newdata.m <-pca.data %>%
  filter(species =="Antigone canadensis canadensis")%>%
  group_by(sex="M") %>%
  droplevels()%>% #drop unused but present unknown level
  data_grid(log_mass.z = seq(from=min(pca.data[,"log_mass.z"]), to=max(pca.data[,"log_mass.z"]), len= 50))

tidy_pred.m <- greater_PC_models[[3]][[2]] %>% 
  epred_draws(newdata = newdata.m )

tidy.pred.contrasts.l <-
  data.frame(
    contrast = (tidy_pred.m$.epred - tidy_pred.f$.epred),
    SDI = (tidy_pred.m$.epred - tidy_pred.f$.epred) /
      tidy_pred.f$.epred,
    log_mass.z = tidy_pred.f$log_mass.z
  )

p<-tidy.pred.contrasts.l%>%
  ggplot(., aes(log_mass.z, contrast))+
  stat_ribbon(alpha=0.6, .width = c(0.5, 0.6, 0.7, 0.8, 0.9))+
  scale_fill_brewer(palette = "Greys")+
  scale_color_brewer(palette = "Greys")+
  geom_hline(yintercept = 0, linetype="dashed")+
  annotate("rect", xmin = min_mass_males, xmax = max_mass_females, ymin = -Inf, ymax =  Inf,
           alpha = .1,fill = "blue")+
  labs(x=expression(paste("standardized(log"["10"], "mass)", sep="")), y="trachea PC1 contrast (M-F)")+
  scale_y_continuous(limits = c(-0.02, 0.1))
p
ggsave(p, filename=paste(figures, "lesser_raw_trachea_PC1_contrasts_by_weight_interaction_conservative.pdf", sep=""), width=4.7, height=3.5, device=cairo_pdf)

#Uninterpretable

p<-tidy.pred.contrasts.l%>%
  ggplot(., aes(log_mass.z, SDI))+
  annotate("rect", xmin = -0.181921793
, xmax = 0.83078782, ymin = -Inf, ymax =  Inf,
           alpha = .3,fill = "grey")+
  annotate("rect", xmin = -1.07444071, xmax = 0.7948448308, ymin = -Inf, ymax =  Inf,
           alpha = .2,fill = "darkred")+
  stat_ribbon(alpha=0.6, .width = c(0.5, 0.6, 0.7, 0.8, 0.9))+
  stat_ribbon(data=tidy.pred.contrasts.g, aes(log_mass.z, SDI), alpha=0.4, .width = c(0.5, 0.6, 0.7, 0.8, 0.9), fill="darkred")+
  scale_fill_brewer(palette = "Greys")+
  scale_color_brewer(palette = "Greys")+
  geom_hline(yintercept = 0, linetype="dashed")+
  
  labs(x=expression(paste("standardized(log"["10"], "mass)", sep="")), y=expression(paste("SDI"["tracheal length"])))
p
ggsave(p+ theme(), filename=paste(figures, "Greater &lesser_trachea_PC!1_SDI_by_weight_interaction_models_conservative.pdf", sep=""), width=4.9, height=3.5, device=cairo_pdf)

```
Incomprehensible

### SDI-mtl plot

```{r, echo=F}

SDI.plot <- data.frame(x=tidy.pred.contrasts.g$SDI, Taxon="greater")
SDI.plot <- rbind(SDI.plot, data.frame(x=tidy.pred.contrasts.l$SDI, Taxon="lesser"))
SDI.plot%>%
  group_by(Taxon)%>%
  summarise(median = median(x),
            mean= mean(x),
            se = std.error(x),
            lower95CI = quantile(x, probs=c(0.025)),
            upper95CI = quantile(x, probs=c(0.975)))

p<-ggplot(SDI.plot, aes(x=x,y=Taxon, fill=Taxon))+
  geom_vline(xintercept = 0, linetype="dashed", alpha=0.3)+
  stat_halfeye(alpha=0.7)+
  #scale_fill_manual(values=c("dodgerblue2", "darkorchid1"))+
  theme(legend.title = element_blank(),
        legend.position = "none")+
  scale_fill_crane("cranes")+
  labs(x=expression(paste("SDI"[italic("trachea")])), y="")+
  scale_x_continuous(limits = c(-1, 1))
p
ggsave(p, filename = paste0(figures, "SDI_PC1_trachea_grey_additive_conservative.pdf"), width=5, height=4, device = cairo_pdf)

```

```{r, `cohenD`}

cohen.d(SDI.pred.l, SDI.pred.g)
# Cohen's d
# 
# d estimate: 2.906798 (large)
# 95 percent confidence interval:
#    lower    upper 
# 2.817897 2.995700 
```

## Segment width ~ residual models
```{R `runresidmodels`}

source("functions/model_runners.R")

#dat.g <- dat.g%>%
#  filter(bursa %in% c("N", "N "))

#run models
# run_my_residual_models(dat.g, "greater_res_models", seed=6)
# run_my_residual_models(dat.l, "lesser_res_models", seed=6)
# 
# save(greater_res_models, file=paste0(models, "greater_res_models.Rdata"))
# save(lesser_res_models, file=paste0(models, "lesser_res_models.Rdata"))

load(file=paste0(models, "greater_res_models.Rdata"))
load(file=paste0(models, "lesser_res_models.Rdata"))
```

### Examine model fit
### Rhat ESS

First look at Rhat values, ESS (n_eff), and parameter estimates.
Greaters first
```{r}
greater_res_models[[3]][[1]][["fit"]]
greater_res_models[[3]][[2]][["fit"]]
greater_res_models[[3]][[3]][["fit"]]
greater_res_models[[3]][[4]][["fit"]]
greater_res_models[[3]][[5]][["fit"]]



```
No R hat over 1 and acceptable ESS.


Lessers
```{r}
lesser_res_models[[3]][[1]][["fit"]]
lesser_res_models[[3]][[2]][["fit"]]
lesser_res_models[[3]][[3]][["fit"]]
lesser_res_models[[3]][[4]][["fit"]]
lesser_res_models[[3]][[5]][["fit"]]


```
No R hat over 1 and acceptable ESS.

### PP checks
Greaters
Null: segement width ~ 1
```{r, `greaterresidppcheck`, figures-side, fig.show="hold", out.width="33%"}

color_scheme_set(scheme = "darkgray")
pp_check(greater_res_models[[3]][[1]], ndraws = 100) 
pp_check(greater_res_models[[3]][[1]], type = "stat", stat = 'median', ndraws = 2000)
pp_check(greater_res_models[[3]][[1]], type = "stat", stat = 'mean', ndraws = 2000)

```

Two-term additive: segement width ~ r
```{r, `greaterresidppcheck`, figures-side, fig.show="hold", out.width="33%"}

color_scheme_set(scheme = "darkgray")
pp_check(greater_res_models[[3]][[2]], ndraws = 100) 
pp_check(greater_res_models[[3]][[2]], type = "stat", stat = 'median', ndraws = 2000)
pp_check(greater_res_models[[3]][[2]], type = "stat", stat = 'mean', ndraws = 2000)

```

Full additive: segement width ~ sex
```{r, `greaterresidppcheck`, figures-side, fig.show="hold", out.width="33%"}

color_scheme_set(scheme = "darkgray")
pp_check(greater_res_models[[3]][[3]], ndraws = 100) 
pp_check(greater_res_models[[3]][[3]], type = "stat", stat = 'median', ndraws = 2000)
pp_check(greater_res_models[[3]][[3]], type = "stat", stat = 'mean', ndraws = 2000)

```

Full Additive: segement width ~ r + sex
```{r, `greaterresidppcheck`, figures-side, fig.show="hold", out.width="33%"}

color_scheme_set(scheme = "darkgray")
pp_check(greater_res_models[[3]][[4]], ndraws = 100) 
pp_check(greater_res_models[[3]][[4]], type = "stat", stat = 'median', ndraws = 2000)
pp_check(greater_res_models[[3]][[4]], type = "stat", stat = 'mean', ndraws = 2000)

```

Full Interaction: segment width ~ resid + sex + sex*resid
```{r, `greaterresidppcheck`, figures-side, fig.show="hold", out.width="33%"}

color_scheme_set(scheme = "darkgray")
pp_check(greater_res_models[[3]][[5]], ndraws = 100) 
pp_check(greater_res_models[[3]][[5]], type = "stat", stat = 'median', ndraws = 2000)
pp_check(greater_res_models[[3]][[5]], type = "stat", stat = 'mean', ndraws = 2000)

```

Lessers
Null: segement width ~ 1
```{r, `lesserresidppcheck`, figures-side, fig.show="hold", out.width="33%"}

color_scheme_set(scheme = "darkgray")
pp_check(lesser_res_models[[3]][[1]], ndraws = 100) 
pp_check(lesser_res_models[[3]][[1]], type = "stat", stat = 'median', ndraws = 2000)
pp_check(lesser_res_models[[3]][[1]], type = "stat", stat = 'mean', ndraws = 2000)

```

Two-term additive: segement width ~ resid
```{r, `lesserresidppcheck`, figures-side, fig.show="hold", out.width="33%"}

color_scheme_set(scheme = "darkgray")
pp_check(lesser_res_models[[3]][[2]], ndraws = 100) 
pp_check(lesser_res_models[[3]][[2]], type = "stat", stat = 'median', ndraws = 2000)
pp_check(lesser_res_models[[3]][[2]], type = "stat", stat = 'mean', ndraws = 2000)

```

Catagorical additive: segement width ~  sex
```{r, `lesserresidppcheck`, figures-side, fig.show="hold", out.width="33%"}

color_scheme_set(scheme = "darkgray")
pp_check(lesser_res_models[[3]][[3]], ndraws = 100) 
pp_check(lesser_res_models[[3]][[3]], type = "stat", stat = 'median', ndraws = 2000)
pp_check(lesser_res_models[[3]][[3]], type = "stat", stat = 'mean', ndraws = 2000)

```

Full additive: segement width ~ resid + sex
```{r, `lesserresidppcheck`, figures-side, fig.show="hold", out.width="33%"}

color_scheme_set(scheme = "darkgray")
pp_check(lesser_res_models[[3]][[4]], ndraws = 100) 
pp_check(lesser_res_models[[3]][[4]], type = "stat", stat = 'median', ndraws = 2000)
pp_check(lesser_res_models[[3]][[4]], type = "stat", stat = 'mean', ndraws = 2000)

```

Full interaction: segment width ~ resid + sex + resid * sex
```{r, `lesserresidppcheck`, figures-side, fig.show="hold", out.width="33%"}

color_scheme_set(scheme = "darkgray")
pp_check(lesser_res_models[[3]][[4]], ndraws = 100) 
pp_check(lesser_res_models[[3]][[4]], type = "stat", stat = 'median', ndraws = 2000)
pp_check(lesser_res_models[[3]][[4]], type = "stat", stat = 'mean', ndraws = 2000)

```


### Model comparison
greaters
```{r}

greater_res_models[[3]][[6]]

```
Full interaction model is best. 

Bayes R^2
```{r}

greater_res_models[[3]][[7]][[1]]
greater_res_models[[3]][[7]][[2]]
greater_res_models[[3]][[7]][[3]]
greater_res_models[[3]][[7]][[4]]
greater_res_models[[3]][[7]][[5]]


```

lessers
LOOIC
```{r}

lesser_res_models[[3]][[6]]

```
simple additive model segement width ~ resid

Bayes R^2
```{r}

lesser_res_models[[3]][[7]][[1]]
lesser_res_models[[3]][[7]][[2]]
lesser_res_models[[3]][[7]][[3]]
lesser_res_models[[3]][[7]][[4]]
lesser_res_models[[3]][[7]][[5]]

```

### Plotting
### Conditional effects
Here we plot conditional effects from best model for greaters
```{r, `conEffectGreater`, figures-side, fig.show="hold", out.width="50%"}
ce1 <- conditional_effects(greater_res_models[[3]][[5]])

p <- ggplot(ce1$r, aes(effect1__, estimate__))+
  geom_ribbon(aes(ymin=lower__, ymax=upper__), fill="grey")+
  geom_line(color="black", linetype="dashed")+
  labs( x=expression(log["10"](mass~(g))), y=expression(log["10"]("mean trachea length (mm)")))
p
ggsave(p +theme(), filename = paste0(figures,"Greater_cond_eff_resid-seg_width_conservative.pdf"), height = 4, width = 4.6, units = "in", device = cairo_pdf)


p1 <- ggplot(ce1$`r:sex`, aes(effect1__, estimate__, fill=effect2__))+
  geom_ribbon(aes(ymin=lower__, ymax=upper__), alpha=0.7)+
   geom_line(color="black", linetype="dashed")+
  scale_fill_sex("sexes")+
  labs( x="ring width (mm)", y="residuals: trachea ~ mass")
p1
ggsave(p1 +theme(), filename = paste0(figures,"Greater_cond_eff_resid-seg_width-int-sex_conservative.pdf"), height = 4, width = 4.6, units = "in", device = cairo_pdf)

```

lessers
```{r, `conEffectLesser`, figures-side, fig.show="hold", out.width="50%"}
#HERE WE USE the Interaction model just of examine basically equivalent models
ce <- conditional_effects(lesser_res_models[[3]][[2]])

p <- ggplot(ce$r, aes(effect1__, estimate__))+
  geom_ribbon(aes(ymin=lower__, ymax=upper__), fill="grey")+
  geom_line(color="black", linetype="dashed")+
 labs( x="ring width (mm)", y="residuals: trachea ~ mass")
p
ggsave(p +theme(), filename = paste0(figures,"Lesser_cond_eff_resid-seg_width_conservative.pdf"), height = 4, width = 4.6, units = "in", device = cairo_pdf)


```

```{r, `conEffectLesser`, figures-side, fig.show="hold", out.width="50%"}
#HERE WE USE the Interaction model just to see though not supported over simpole additive
ce <- conditional_effects(lesser_res_models[[3]][[5]], spaghetti = T)

p <- ggplot(ce$`r:sex`, aes(effect1__, estimate__, fill=effect2__))+
  geom_ribbon(aes(ymin=lower__, ymax=upper__), alpha=0.7)+
  geom_line(color="black", linetype="dashed")+
  scale_fill_sex("sexes")+
 labs( x="ring width (mm)", y="residuals: trachea ~ mass")
p
ggsave(p +theme(), filename = paste0(figures,"Lesser_cond_eff_resid-seg_width_conservative.pdf"), height = 4, width = 4.6, units = "in", device = cairo_pdf)


```

```{r}
p1 <- ggplot()+
  geom_line(data=ce$r, aes(effect1__, estimate__),color="black", linetype="dashed")+
  geom_ribbon(data=ce$r, aes(x=effect1__, ymin=lower__, ymax=upper__), alpha=0.5, fill="seashell3")+
  geom_line(data=ce1$r, aes(effect1__, estimate__),color="black", linetype="dashed")+
  geom_ribbon(data=ce1$r, aes(x=effect1__, ymin=lower__, ymax=upper__), alpha=0.5, fill="#A62800")+
   labs( x="ring width (mm)", y="residuals: trachea ~ mass")
p1
ggsave(p1 +theme(), filename = paste0(figures,"Greater-and_lesser_cond_eff_resid-seg_width_conservative.pdf"), height = 4, width = 4.6, units = "in", device = cairo_pdf)
#greater red here lesser grey


```



## Posterior Predictions and Contrasts

greaters

Since we want to make relevant comparisons and interactions are essentially uninterperatable in this context and likely attributed to small samples size we will use the additive model for greaters which is essentially [equivalent by LOOIC](https://discourse.mc-stan.org/t/interpreting-elpd-diff-loo-package/1628).
```{r}
newdata <-dat.g%>%dplyr::select(sex, log_resid, log_mass.z)%>%filter(!sex %in% c("UNKNOWN"))%>%droplevels()

tidy_pred <- greater_res_models[[3]][[5]] %>% 
  epred_draws(newdata = newdata , ndraws = 50)

#get min value for males 
min_mass_males <- tidy_pred%>%
  filter(sex=="M")%>%
  group_by(sex)%>%
  summarise(min_mass_males = min(log_mass.z))%>%
  pull()

#epred off that value
#set up newdataframe
newdata  <- expand_grid(sex = c("M", "F"),
                       log_mass.z = c(min_mass_males))
  

#draw expected values from posterior: this is more of a population estimate (smaller associated error)

tidy_pred <- greater_res_models[[3]][[5]] %>% 
  epred_draws(newdata = newdata)
tidy_pred

#find difference between each "pair of values
library(dplyr)
M.pred <- tidy_pred%>%
  filter(sex=="M")

F.pred <- tidy_pred%>%
  filter(sex=="F")

SDI.pred.g <- (M.pred$.epred -F.pred$.epred)/F.pred$.epred



newdata.f <-dat.g %>%
  group_by(sex="F") %>%
  droplevels()%>% #drop unused but present unknown level
  data_grid(log_mass.z = seq(from=min(dat.g[,"log_mass.z"]), to=max(dat.g[,"log_mass.z"]), len= 50))

tidy_pred.f <- greater_res_models[[3]][[5]] %>% 
  epred_draws(newdata = newdata.f )


newdata.m <-dat.g %>%
  group_by(sex="M") %>%
  droplevels()%>% #drop unused but present unknown level
  data_grid(log_mass.z = seq(from=min(dat.g[,"log_mass.z"]), to=max(dat.g[,"log_mass.z"]), len= 50))

tidy_pred.m <- greater_res_models[[3]][[5]] %>% 
  epred_draws(newdata = newdata.m )

tidy.pred.contrasts.g <-
  data.frame(
    contrast = (tidy_pred.m$.epred - tidy_pred.f$.epred),
    SDI = (tidy_pred.m$.epred - tidy_pred.f$.epred) /
      tidy_pred.f$.epred,
    log_mass.z = tidy_pred.f$log_mass.z
  )

p<-tidy.pred.contrasts.g%>%
  ggplot(., aes(log_mass.z, contrast))+
  stat_ribbon(alpha=0.6, .width = c(0.5, 0.6, 0.7, 0.8, 0.9))+
  scale_fill_brewer(palette = "Greys")+
  scale_color_brewer(palette = "Greys")+
  geom_hline(yintercept = 0, linetype="dashed")+
  annotate("rect", xmin = -1.07444071, xmax = 0.7948448308, ymin = -Inf, ymax =  Inf,
           alpha = .1,fill = "blue")+
  labs(x=expression(paste("standardized(log"["10"], "mass)", sep="")), y="tracheal length contrast (M-F)")+
  scale_y_continuous(limits = c(-0.08, 0.1))
p
ggsave(p, filename=paste(figures, "greater_trachea_contrasts_by_weight_conservative_interaction.pdf", sep=""), width=4.7, height=3.5, device=cairo_pdf)


p<-tidy.pred.contrasts.g%>%
  ggplot(., aes(log_mass.z, SDI))+
  stat_ribbon(alpha=0.6, .width = c(0.5, 0.6, 0.7, 0.8, 0.9))+
  scale_fill_brewer(palette = "Greys")+
  scale_color_brewer(palette = "Greys")+
  geom_hline(yintercept = 0, linetype="dashed")+
  annotate("rect", xmin = -1.07444071, xmax = 0.7948448308, ymin = -Inf, ymax =  Inf,
           alpha = .1,fill = "blue")+
  labs(x=expression(paste("standardized(log"["10"], "mass)", sep="")), y=expression(paste("SDI"["tracheal length"])))+
  scale_y_continuous(limits = c(-0.02, 0.05))
p
ggsave(p, filename=paste(figures, "greater_SDI_contrasts_by_weight_conservative_interaction.pdf", sep=""), width=4.7, height=3.5, device=cairo_pdf)
```

lessers

```{r}

newdata <-dat.l%>%dplyr::select(sex, log_resid, log_mass.z)%>%filter(!sex %in% c("UNKNOWN"))%>%droplevels()

tidy_pred <- lesser_res_models[[3]][[5]] %>% 
  epred_draws(newdata = newdata , ndraws=50)

#get min value for males 
min_mass_males <- tidy_pred%>%
  filter(sex=="M")%>%
  group_by(sex)%>%
  dplyr::summarise(min_mass_males = min(log_mass.z))%>%
  pull()

#pred off that value
#set up newdataframe
newdata  <- expand_grid(sex = c("M", "F"),
                       log_mass.z = c(min_mass_males))
  

#draw expected values from posterior: this is more of a population estimate (smaller associated error)

tidy_pred <- lesser_res_models[[3]][[5]] %>% 
  epred_draws(newdata = newdata )
tidy_pred

#find difference between each "pair of values
library(dplyr)
M.pred <- tidy_pred%>%
  filter(sex=="M")

F.pred <- tidy_pred%>%
  filter(sex=="F")

SDI.pred.l <- (M.pred$.epred -F.pred$.epred)/F.pred$.epred #original way chris suggested same as lovich and gibbons 1992 different formula terms


newdata.f <-dat.l %>%
  group_by(sex="F") %>%
  droplevels()%>% #drop unused but present unknown level
  data_grid(log_mass.z = seq(from=min(dat.l[,"log_mass.z"]), to=max(dat.l[,"log_mass.z"]), len= 50))

tidy_pred.f <- lesser_res_models[[3]][[5]] %>% 
  epred_draws(newdata = newdata.f )


newdata.m <-dat.l %>%
  group_by(sex="M") %>%
  droplevels()%>% #drop unused but present unknown level
  data_grid(log_mass.z = seq(from=min(dat.l[,"log_mass.z"]), to=max(dat.l[,"log_mass.z"]), len= 50))

tidy_pred.m <- lesser_res_models[[3]][[5]] %>% 
  epred_draws(newdata = newdata.m )

tidy.pred.contrasts.l <- data.frame(contrast = tidy_pred.m$.epred - tidy_pred.f$.epred,
                                  SDI = (tidy_pred.m$.epred - tidy_pred.f$.epred)/tidy_pred.f$.epred,
                                  log_mass.z = tidy_pred.f$log_mass.z)

p<-tidy.pred.contrasts.l%>%
  ggplot(., aes(log_mass.z, contrast))+
  stat_ribbon(alpha=0.6, .width = c(0.5, 0.6, 0.7, 0.8, 0.9))+
  scale_fill_brewer(palette = "Greys")+
  scale_color_brewer(palette = "Greys")+
  geom_hline(yintercept = 0, linetype="dashed")+
  annotate("rect", xmin = -0.181921793
, xmax = 0.83078782, ymin = -Inf, ymax =  Inf,
           alpha = .1,fill = "blue")+
  labs(x=expression(paste("standardized(log"["10"], "mass)", sep="")), y="tracheal length contrast (M-F)")+
  scale_y_continuous(limits = c(-0.08, 0.1))
p
ggsave(p, filename=paste(figures, "lesser_raw_trachea_contrasts_by_weight_interaction_conservative.pdf", sep=""), width=4.7, height=3.5, device=cairo_pdf)

p<-tidy.pred.contrasts.l%>%
  ggplot(., aes(log_mass.z, SDI))+
  annotate("rect", xmin = -0.181921793
, xmax = 0.83078782, ymin = -Inf, ymax =  Inf,
           alpha = .3,fill = "grey")+
  annotate("rect", xmin = -1.07444071, xmax = 0.7948448308, ymin = -Inf, ymax =  Inf,
           alpha = .2,fill = "darkred")+
  stat_ribbon(alpha=0.6, .width = c(0.5, 0.6, 0.7, 0.8, 0.9))+
  stat_ribbon(data=tidy.pred.contrasts.g, aes(log_mass.z, SDI), alpha=0.4, .width = c(0.5, 0.6, 0.7, 0.8, 0.9), fill="darkred")+
  scale_fill_brewer(palette = "Greys")+
  scale_color_brewer(palette = "Greys")+
  geom_hline(yintercept = 0, linetype="dashed")+
  
  labs(x=expression(paste("standardized(log"["10"], "mass)", sep="")), y=expression(paste("SDI"["tracheal length"])))+
  scale_y_continuous(limits = c(-0.001, 0.02))
p
ggsave(p+ theme(), filename=paste(figures, "Greater &lesser_SDI_by_weight_interaction_models_conservative.pdf", sep=""), width=4.9, height=3.5, device=cairo_pdf)

```

### SDI-resid plot

```{r, echo=F}

SDI.plot <- data.frame(x=tidy.pred.contrasts.g$SDI, Taxon="greater")
SDI.plot <- rbind(SDI.plot, data.frame(x=tidy.pred.contrasts.l$SDI, Taxon="lesser"))
SDI.plot%>%
  group_by(Taxon)%>%
  summarise(median = median(x),
            mean= mean(x),
            se = std.error(x),
            lower95CI = quantile(x, probs=c(0.025)),
            upper95CI = quantile(x, probs=c(0.975)))

p<-ggplot(SDI.plot, aes(x=x,y=Taxon, fill=Taxon))+
  geom_vline(xintercept = 0, linetype="dashed", alpha=0.3)+
  stat_halfeye(alpha=0.7)+
  #scale_fill_manual(values=c("dodgerblue2", "darkorchid1"))+
  theme(legend.title = element_blank(),
        legend.position = "none")+
  scale_fill_crane("cranes")+
  labs(x=expression(paste("SDI"[italic("trachea")])), y="")
p
ggsave(p, filename = paste0(figures, "SDI_PP_trachea_grey_additive_conservative.pdf"), width=5, height=4, device = cairo_pdf)

```

```{r, `cohenD`}

cohen.d(SDI.pred.l, SDI.pred.g)
# Cohen's d
# 
# d estimate: 2.906798 (large)
# 95 percent confidence interval:
#    lower    upper 
# 2.817897 2.995700 
```

### Bayesian predictions trachea length \~ mass


### Bayesian SDI mass \~ mtl

```{R}
l<-dat.l %>%
  group_by(sex) %>%
   filter(sex %in% c("M", "F")) %>% 
   droplevels()%>%
  data_grid(log_mtl = seq_range(log_mtl, n = 100)) %>%
  add_epred_draws(mm2.a.l) %>%
  ggplot(aes(x = log_mtl, y = log_mass, color = ordered(sex))) +
  stat_lineribbon(aes(y = .epred)) +
  geom_point(data = dat.l, alpha=0.3) +
  scale_fill_brewer(palette = "Greys") +
  scale_color_brewer(palette = "Set2")+
  labs( x=expression(log["10"]("mean trachea length (mm)")), y=expression(log["10"](mass~(g))))+
   theme_classic(base_size = 14)+
  theme(legend.title = element_blank(),
        legend.position = "none")
  ggsave(l, filename = paste(getwd(), "/figures/Epredictions_lessers_SDImass_conservative.pdf", sep=""), width=5, height = 5)
 


g<-dat.g %>%
  group_by(sex) %>%
   filter(sex %in% c("M", "F")) %>% 
   droplevels()%>%
  data_grid(log_mtl = seq_range(log_mtl, n = 100)) %>%
  add_epred_draws(mm2.a.g) %>%
  ggplot(aes(x = log_mtl, y = log_mass, color = ordered(sex))) +
  stat_lineribbon(aes(y = .epred)) +
  geom_point(data = dat.g, alpha=0.3) +
  scale_fill_brewer(palette = "Greys") +
  scale_color_brewer(palette = "Set2")+
  labs( x=expression(log["10"]("mean trachea length (mm)")), y=expression(log["10"](mass~(g))))+
   theme_classic(base_size = 14)+
  theme(legend.title = element_blank(),
        legend.position = "none")

ggsave(g, filename = paste(getwd(), "/figures/Epredictions_greaters_SDImass_conservative.pdf", sep=""), width=5, height = 5)
  
```

## Segment by trachea length models

Let's allow mean tracheae length mass, sex to predict segment density

### Lessers only intercept only model

```{r}


seg.l.int.only <- brm(
  formula = bf(segment_width ~ 1),
  data = dat.l,
  family = gaussian(),
  cores = 4,
  chains = 4,
  thin = 10, #chop out transitions?
  warmup = 10000, #half of iterations
  iter = 20000,
  prior = c(
      prior(student_t(3, 0.5, 2.5), "Intercept")),
  #prior = priors,
  save_pars = save_pars(all = TRUE), #need this for loo comparison
  control = list(adapt_delta = 0.97, max_treedepth = 19), #adapt_delta the target average proposal acceptance probability during Stan's adaptation period
  set.seed(2020)
)

save(seg.l.int.only, file=paste(getwd(), "/models/", "crane_trachea_segments_lesser_int_only_fam_poisson_conservative.Rdata", sep="")) # save model

#load("crane_trachea_segments_lesser_int_only_fam_gaussian_conservative.Rdata") # If loading from pre-saved file and not re-running

seg.l.int.only

# pp check
pp_check(seg.l.int.only, ndraws = 100) 
pp_check(seg.l.int.only, type = "stat", stat = 'median', ndraws = 2000)
pp_check(seg.l.int.only, type = "stat", stat = 'mean', ndraws = 2000)

# trace and density plots
plot(seg.l.int.only)

# pairwise plots
pairs(seg.l.int.only)


# Quick plot of estimates and 95% CIs (default is 95% CI:
#mcmc_plot(m1.a.l)
mcmc_plot(seg.l.int.only,
           prob_outer = 0.95)

plot(conditional_effects(seg.l.int.only), points = F) 


# Changes the fixed effects (i.e. random variable) to odd's ratio 
exp(fixef(seg.l.int.only)[,-2])


```

### Lessers only additive 1-term (sex)

```{r}

#use this to get idea of priors then set your own!!
# priors <-get_prior(log_mtl ~ 1 + log10(segment_width)  + sex,
#                    data = dat.l, family = gaussian())

seg1.l.a.s <- brm(
  formula = bf(segment_width ~ 1 + sex),
  data = dat.l,
  family = gaussian(),
  cores = 4,
  chains = 4,
  thin = 10, #chop out transitions?
  warmup = 10000, #half of iterations
  iter = 20000,
  prior = c(
      prior(student_t(3, 0.5, 2.5), "Intercept")),
  #prior = priors,
  save_pars = save_pars(all = TRUE), #need this for loo comparison
  control = list(adapt_delta = 0.97, max_treedepth = 19), #adapt_delta the target average proposal acceptance probability during Stan's adaptation period
  set.seed(2020)
)

save(seg1.l.a.s, file=paste(getwd(), "/models/", "crane_trachea_segments_lesser_additive_sex_fam_poisson_conservative.Rdata", sep="")) # save model

#load("crane_trachea_segments_lesser_additive_sex_fam_gaussian_conservative.Rdata") # If loading from pre-saved file and not re-running

seg1.l.a.s

# pp check
pp_check(seg1.l.a.s, ndraws = 100) 
pp_check(seg1.l.a.s, type = "stat", stat = 'median', ndraws = 2000)
pp_check(seg1.l.a.s, type = "stat", stat = 'mean', ndraws = 2000)

# trace and density plots
plot(seg1.l.a.s)

# pairwise plots
pairs(seg1.l.a.s)


# Quick plot of estimates and 95% CIs (default is 95% CI:
#mcmc_plot(m1.a.l)
mcmc_plot(seg1.l.a.s,
           prob_outer = 0.95)

plot(conditional_effects(seg1.l.a.s), points = F) 


# Changes the fixed effects (i.e. random variable) to odd's ratio 
exp(fixef(seg1.l.a.s)[,-2])


```

### Lessers only additive 1-term (bursa)

```{r}

seg1.l.a.b <- brm(
  formula = bf(log10(segment_width) ~ 1 + log10(mass)),
  data = dat.l,
  family = gaussian(),
  cores = 4,
  chains = 4,
  thin = 10, #chop out transitions?
  warmup = 10000, #half of iterations
  iter = 20000,
  prior = c(
      prior(student_t(3, 0.5, 2.5), "Intercept")),
  #prior = priors,
  save_pars = save_pars(all = TRUE), #need this for loo comparison
  control = list(adapt_delta = 0.97, max_treedepth = 19), #adapt_delta the target average proposal acceptance probability during Stan's adaptation period
  set.seed(2020)
)

save(seg1.l.a.b, file=paste(getwd(), "/models/", "crane_trachea_segments_lesser_additive_bursa_fam_poisson_conservative.Rdata", sep="")) # save model

#load("crane_trachea_segments_lesser_additive_sex_fam_poisson_conservative.Rdata") # If loading from pre-saved file and not re-running

seg1.l.a.b


# pp check
pp_check(seg1.l.a.b, ndraws = 100) 
pp_check(seg1.l.a.b, type = "stat", stat = 'median', ndraws = 2000)
pp_check(seg1.l.a.b, type = "stat", stat = 'mean', ndraws = 2000)

# trace and density plots
plot(seg1.l.a.b)

# pairwise plots
pairs(seg1.l.a.b)


# Quick plot of estimates and 95% CIs (default is 95% CI:
#mcmc_plot(m1.a.l)
mcmc_plot(seg1.l.a.b,
           prob_outer = 0.95)

plot(conditional_effects(seg1.l.a.b), points = F) 


# Changes the fixed effects (i.e. random variable) to odd's ratio 
exp(fixef(ms1.a.b)[,-2])


```

### Lessers only additive 1-term (mtl)

```{r}

seg1.l.a.t <- brm(
  formula = bf(segment_width ~ 1 + log_mtl),
  data = dat.l,
  family = gaussian(),
  cores = 4,
  chains = 4,
  thin = 10, #chop out transitions?
  warmup = 10000, #half of iterations
  iter = 20000,
  prior = c(
      prior(student_t(3, 0.5, 2.5), "Intercept"),
      prior(normal(0,5), class="b")),
  #prior = priors,
  save_pars = save_pars(all = TRUE), #need this for loo comparison
  control = list(adapt_delta = 0.97, max_treedepth = 19), #adapt_delta the target average proposal acceptance probability during Stan's adaptation period
  set.seed(2020)
)

save(seg1.l.a.t, file=paste(getwd(), "/models/", "crane_trachea_segments_lesser_additive_mtl_fam_poisson_conservative.Rdata", sep="")) # save model

#load("crane_trachea_segments_lesser_additive_sex_fam_poisson_conservative.Rdata") # If loading from pre-saved file and not re-running

seg1.l.a.t

# pp check
pp_check(seg1.l.a.t, ndraws = 100) 
pp_check(seg1.l.a.t, type = "stat", stat = 'median', ndraws = 2000)
pp_check(seg1.l.a.t, type = "stat", stat = 'mean', ndraws = 2000)

# trace and density plots
plot(seg1.l.a.t)

# pairwise plots
pairs(seg1.l.a.t)


# Quick plot of estimates and 95% CIs (default is 95% CI:
#mcmc_plot(m1.a.l)
mcmc_plot(seg1.l.a.t,
           prob_outer = 0.95)

plot(conditional_effects(seg1.l.a.t), points = F) 


# Changes the fixed effects (i.e. random variable) to odd's ratio 
exp(fixef(ms1.a.t)[,-2])


```

### Lessers only additive 2-term (sex + bursa)

```{r}

seg2.l.a.sb <- brm(
  formula = bf(segment_width ~ 1 + sex),
  data = dat.l,
  family = poisson(),
  cores = 4,
  chains = 4,
  thin = 10, #chop out transitions?
  warmup = 10000, #half of iterations
  iter = 20000,
  prior = c(
      prior(student_t(3, 2.8, 2.5), "Intercept")),
  #prior = priors,
  save_pars = save_pars(all = TRUE), #need this for loo comparison
  control = list(adapt_delta = 0.97, max_treedepth = 19), #adapt_delta the target average proposal acceptance probability during Stan's adaptation period
  set.seed(2020)
)

save(seg2.l.a.sb, file=paste(getwd(), "/models/", "crane_trachea_segments_lesser_additive_bursa-sex_fam_poisson_conservative.Rdata", sep="")) # save model

#load("crane_trachea_segments_lesser_additive_bursa-sex_fam_poisson_conservative.Rdata") # If loading from pre-saved file and not re-running

seg2.l.a.sb

# pp check
pp_check(seg2.l.a.sb, ndraws = 100) 
pp_check(seg2.l.a.sb, type = "stat", stat = 'median', ndraws = 2000)
pp_check(seg2.l.a.sb, type = "stat", stat = 'mean', ndraws = 2000)

# trace and density plots
plot(seg2.l.a.sb)

# pairwise plots
pairs(seg2.l.a.sb)


# Quick plot of estimates and 95% CIs (default is 95% CI:
#mcmc_plot(m1.a.l)
mcmc_plot(seg2.l.a.sb,
           prob_outer = 0.95)

plot(conditional_effects(seg2.l.a.sb), points = F) 


# Changes the fixed effects (i.e. random variable) to odd's ratio 
exp(fixef(seg2.l.a.sb)[,-2])


```

### Lessers only additive 2-term (sex + mtl)

```{r}

seg2.l.a.st <- brm(
  formula = bf(segment_width ~ 1 + sex + log_mtl),
  data = dat.l,
  family = poisson(),
  cores = 4,
  chains = 4,
  thin = 10, #chop out transitions?
  warmup = 10000, #half of iterations
  iter = 20000,
  prior = c(
      prior(student_t(3, 2.8, 2.5), "Intercept"),
      prior(normal(0, 10), coef = "log_mtl")),
  #prior = priors,
  save_pars = save_pars(all = TRUE), #need this for loo comparison
  control = list(adapt_delta = 0.97, max_treedepth = 19), #adapt_delta the target average proposal acceptance probability during Stan's adaptation period
  set.seed(2020)
)

save(seg2.l.a.st, file=paste(getwd(), "/models/", "crane_trachea_segments_lesser_additive_sex-mtl_fam_poisson_conservative.Rdata", sep="")) # save model

#load("crane_trachea_segments_lesser_additive_bursa-sex_fam_poisson_conservative.Rdata") # If loading from pre-saved file and not re-running

seg2.l.a.st

# pp check
pp_check(seg2.l.a.st, ndraws = 100) 
pp_check(seg2.l.a.st, type = "stat", stat = 'median', ndraws = 2000)
pp_check(seg2.l.a.st, type = "stat", stat = 'mean', ndraws = 2000)

# trace and density plots
plot(seg2.l.a.st)

# pairwise plots
pairs(seg2.l.a.st)


# Quick plot of estimates and 95% CIs (default is 95% CI:
#mcmc_plot(m1.a.l)
mcmc_plot(seg2.l.a.st,
           prob_outer = 0.95)

plot(conditional_effects(seg2.l.a.st), points = F) 


# Changes the fixed effects (i.e. random variable) to odd's ratio 
exp(fixef(seg2.l.a.st)[,-2])


```

### Lessers only additive 2-term (bursa + mtl)

```{r}

seg2.l.a.bt <- brm(
  formula = bf(segment_width ~ 1 + bursa + log_mtl),
  data = dat.l,
  family = poisson(),
  cores = 4,
  chains = 4,
  thin = 10, #chop out transitions?
  warmup = 10000, #half of iterations
  iter = 20000,
  prior = c(
      prior(student_t(3, 2.8, 2.5), "Intercept"),
      prior(normal(0, 10), coef = "log_mtl")),
  #prior = priors,
  save_pars = save_pars(all = TRUE), #need this for loo comparison
  control = list(adapt_delta = 0.97, max_treedepth = 19), #adapt_delta the target average proposal acceptance probability during Stan's adaptation period
  set.seed(2020)
)

save(seg2.l.a.bt, file=paste(getwd(), "/models/", "crane_trachea_segments_lesser_additive_bursa-mtl_fam_poisson_conservative.Rdata", sep="")) # save model

#load("crane_trachea_segments_lesser_additive_bursa-sex_fam_poisson_conservative.Rdata") # If loading from pre-saved file and not re-running

# pp check
pp_check(seg2.l.a.bt, ndraws = 100) 
pp_check(seg2.l.a.bt, type = "stat", stat = 'median', ndraws = 2000)
pp_check(seg2.l.a.bt, type = "stat", stat = 'mean', ndraws = 2000)

# trace and density plots
plot(seg2.l.a.bt)

# pairwise plots
pairs(seg2.l.a.bt)


# Quick plot of estimates and 95% CIs (default is 95% CI:
#mcmc_plot(m1.a.l)
mcmc_plot(seg2.l.a.bt,
           prob_outer = 0.95)

plot(conditional_effects(seg2.l.a.bt), points = F) 


# Changes the fixed effects (i.e. random variable) to odd's ratio 
exp(fixef(seg2.l.a.bt)[,-2])


```

### Lessers only three term additive (mtl + sex + bursa)

```{r}

seg3.l.a.tbs <- brm(
  formula = bf(segment_width ~ 1 + log_mtl + bursa + sex),
  data = dat.l,
  family = poisson(),
  cores = 4,
  chains = 4,
  thin = 10, #chop out transitions?
  warmup = 10000, #half of iterations
  iter = 20000,
  prior = c(
      prior(student_t(3, 2.8, 2.5), "Intercept"),
     prior(normal(0, 10), coef="log_mtl")),
  #prior = priors,
  save_pars = save_pars(all = TRUE), #need this for loo comparison
  control = list(adapt_delta = 0.97, max_treedepth = 19), #adapt_delta the target average proposal acceptance probability during Stan's adaptation period
  set.seed(2020)
)

save(seg3.l.a.tbs, file=paste(getwd(), "/models/", "crane_trachea_segments_lesser_additive_full_fam_poisson_conservative.Rdata", sep="")) # save model

#load("crane_trachea_lesser_additive_full_fam_gaussian_conservative.Rdata") # If loading from pre-saved file and not re-running

# pp check
pp_check(seg3.l.a.tbs, ndraws = 100) 
pp_check(seg3.l.a.tbs, type = "stat", stat = 'median', ndraws = 2000)
pp_check(seg3.l.a.tbs, type = "stat", stat = 'mean', ndraws = 2000)

# trace and density plots
plot(seg3.l.a.tbs)

# pairwise plots
pairs(seg3.l.a.tbs)


# Quick plot of estimates and 95% CIs (default is 95% CI:
#mcmc_plot(m1.a.l)

mcmc_plot(seg3.l.a.tbs,
           prob_outer = 0.95)

plot(conditional_effects(seg3.l.a.tbs), points = F) 


# Changes the fixed effects (i.e. random variable) to odd's ratio 
exp(fixef(seg3.l.a.tbs)[,-2])


```

### Lessers only two term interaction (mtl + sex)

```{r}

seg2.l.i.s.t <- brm(
  formula = bf(segment_width ~ 1 + (sex + log_mtl)^2),
  data = dat.l,
  family = poisson(),
  cores = 4,
  chains = 4,
  thin = 10, #chop out transitions?
  warmup = 10000, #half of iterations
  iter = 20000,
  prior = c(
      prior(student_t(3, 2.8, 2.5), "Intercept"),
     prior(normal(0, 10), coef="log_mtl")),
  #prior = priors,
  save_pars = save_pars(all = TRUE), #need this for loo comparison
  control = list(adapt_delta = 0.97, max_treedepth = 19), #adapt_delta the target average proposal acceptance probability during Stan's adaptation period
  set.seed(2020)
)

save(seg2.l.i.s.t, file=paste(getwd(), "/models/", "crane_trachea_segments_lesser_interaction_sex-seg_dens_fam_poisson_conservative.Rdata", sep="")) # save model

#load("crane_trachea_lesser_additive_full_fam_gaussian_conservative.Rdata") # If loading from pre-saved file and not re-running

# pp check
pp_check(seg2.l.i.s.t, ndraws = 1000) 
pp_check(seg2.l.i.s.t, type = "stat", stat = 'median', ndraws = 2000)
pp_check(seg2.l.i.s.t, type = "stat", stat = 'mean', ndraws = 2000)

# trace and density plots
plot(seg2.l.i.s.t)

# pairwise plots
pairs(seg2.l.i.s.t)


# Quick plot of estimates and 95% CIs (default is 95% CI:
#mcmc_plot(m1.a.l)
mcmc_plot(seg2.l.i.s.t,
           prob_outer = 0.95)

plot(conditional_effects(seg2.l.i.s.t), points = F) 



# Changes the fixed effects (i.e. random variable) to odd's ratio 
exp(fixef(seg2.l.i.s.t)[,-2])


```

### Model selection

```{r}

# with sex only catagorical
LOO(seg.l.int.only, seg1.l.a.s, seg1.l.a.t, seg2.l.a.st, seg2.l.i.s.t, reloo=FALSE) 

 #Bayes R2
bayes_R2(seg.l.int.only) # 0.0000000000 nothing
bayes_R2(seg1.l.a.s) #0.14
bayes_R2(seg1.l.a.t) #0.014
bayes_R2(seg2.l.a.st) #0.14
bayes_R2(seg2.l.i.s.t) #0.19

#Since we are interested in segments by trachea length here is another model comparison set

LOO(seg.l.int.only, seg1.l.a.t, seg2.l.a.st, seg2.l.i.s.t, reloo=FALSE) 

 #Bayes R2
bayes_R2(seg.l.int.only) # 0.0000000000 nothing
bayes_R2(seg1.l.a.t) #0.014
bayes_R2(seg2.l.a.st) #0.14

```

### Predictions graph

Doing this for model with most explanatory power and since we are interested in sex differences and how segment number changes with trachea length

```{r}
g<-dat.l %>%
  group_by(sex) %>%
   filter(sex %in% c("M", "F")) %>% 
   droplevels()%>%
  data_grid(log_mtl = seq_range(log_mtl, n = 100)) %>%
  add_epred_draws(seg2.l.i.s.t) %>%
  ggplot(aes(x = log_mtl, y = segment_width, color = ordered(sex))) +
  stat_lineribbon(aes(y = .epred), alpha=0.6) +
  geom_point(data = dat.l, alpha=0.3) +
  scale_fill_brewer(palette = "Greys") +
  scale_color_brewer(palette = "Set2")+
  labs( x=expression(log["10"]("mean trachea length (mm)")), y="segment count")+
   theme_classic(base_size = 14)+
  theme(legend.title = element_blank(),
        legend.position = "none")
g
ggsave(g, filename = paste(getwd(), "/figures/Epredictions_greaters_seg_mtl_conservative.pdf", sep=""), width=5, height = 5)
  
```

### Greaters only intercept only model

```{r}


seg.g.int.only <- brm(
  formula = bf(segment_width ~ 1),
  data = dat.g%>%filter(segment_width<350),
  family = gaussian(),
  cores = 4,
  chains = 4,
  thin = 10, #chop out transitions?
  warmup = 10000, #half of iterations
  iter = 20000,
  prior = c(
      prior(student_t(3, 2.8, 2.5), "Intercept")),
  #prior = priors,
  save_pars = save_pars(all = TRUE), #need this for loo comparison
  control = list(adapt_delta = 0.97, max_treedepth = 19), #adapt_delta the target average proposal acceptance probability during Stan's adaptation period
  set.seed(2020)
)

save(seg.g.int.only, file=paste(getwd(), "/models/", "crane_trachea_segments_greater_int_only_fam_gaussian_conservative.Rdata", sep="")) # save model

#load("crane_trachea_segments_lesser_int_only_fam_gaussian_conservative.Rdata") # If loading from pre-saved file and not re-running

seg.g.int.only

# pp check
pp_check(seg.g.int.only, ndraws = 100) 
pp_check(seg.g.int.only, type = "stat", stat = 'median', ndraws = 2000)
pp_check(seg.g.int.only, type = "stat", stat = 'mean', ndraws = 2000)

# trace and density plots
plot(seg.g.int.only)

# pairwise plots
pairs(seg.g.int.only)


# Quick plot of estimates and 95% CIs (default is 95% CI:
#mcmc_plot(m1.a.l)
mcmc_plot(seg.g.int.only,
           prob_outer = 0.95)

plot(conditional_effects(seg.g.int.only), points = F) 


# Changes the fixed effects (i.e. random variable) to odd's ratio 
exp(fixef(seg.g.int.only)[,-2])


```

### greaters only additive 1-term (sex)

```{r}

#use this to get idea of priors then set your own!!
# priors <-get_prior(log_mtl ~ 1 + log10(segment_width)  + sex,
#                    data = dat.g%>%filter(segment_width <350), family = gaussian())

seg1.g.a.s <- brm(
  formula = bf(segment_width ~ 1 + sex),
  data = dat.g%>%filter(segment_width <350),
  family = gaussian(),
  cores = 4,
  chains = 4,
  thin = 10, #chop out transitions?
  warmup = 10000, #half of iterations
  iter = 20000,
  prior = c(
      prior(student_t(3, 2.8, 2.5), "Intercept")),
  #prior = priors,
  save_pars = save_pars(all = TRUE), #need this for loo comparison
  control = list(adapt_delta = 0.97, max_treedepth = 19), #adapt_delta the target average proposal acceptance probability during Stan's adaptation period
  set.seed(2020)
)

save(seg1.g.a.s, file=paste(getwd(), "/models/", "crane_trachea_segments_greater_additive_sex_fam_gaussian_conservative.Rdata", sep="")) # save model

#load("crane_trachea_segments_greater_additive_sex_fam_gaussian_conservative.Rdata") # If loading from pre-saved file and not re-running

seg1.g.a.s

# pp check
pp_check(seg1.g.a.s, ndraws = 100) 
pp_check(seg1.g.a.s, type = "stat", stat = 'median', ndraws = 2000)
pp_check(seg1.g.a.s, type = "stat", stat = 'mean', ndraws = 2000)

# trace and density plots
plot(seg1.g.a.s)

# pairwise plots
pairs(seg1.g.a.s)


# Quick plot of estimates and 95% CIs (default is 95% CI:
#mcmc_plot(m1.a.l)
mcmc_plot(seg1.g.a.s,
           prob_outer = 0.95)

plot(conditional_effects(seg1.g.a.s), points = F) 


# Changes the fixed effects (i.e. random variable) to odd's ratio 
exp(fixef(seg1.g.a.s)[,-2])


```

### greaters only additive 1-term (bursa)

```{r}

seg1.g.a.b <- brm(
  formula = bf(segment_width ~ 1 + bursa),
  data = dat.g,
  family = gaussian(),
  cores = 4,
  chains = 4,
  thin = 10, #chop out transitions?
  warmup = 10000, #half of iterations
  iter = 20000,
  prior = c(
      prior(student_t(3, 2.8, 2.5), "Intercept")),
  #prior = priors,
  save_pars = save_pars(all = TRUE), #need this for loo comparison
  control = list(adapt_delta = 0.97, max_treedepth = 19), #adapt_delta the target average proposal acceptance probability during Stan's adaptation period
  set.seed(2020)
)

save(seg1.g.a.b, file=paste(getwd(), "/models/", "crane_trachea_segments_greater_additive_bursa_fam_gaussian_conservative.Rdata", sep="")) # save model

#load("crane_trachea_segments_greater_additive_sex_fam_poisson_conservative.Rdata") # If loading from pre-saved file and not re-running

seg1.g.a.b


# pp check
pp_check(seg1.g.a.b, ndraws = 100) 
pp_check(seg1.g.a.b, type = "stat", stat = 'median', ndraws = 2000)
pp_check(seg1.g.a.b, type = "stat", stat = 'mean', ndraws = 2000)

# trace and density plots
plot(seg1.g.a.b)

# pairwise plots
pairs(seg1.g.a.b)


# Quick plot of estimates and 95% CIs (default is 95% CI:
#mcmc_plot(m1.a.l)
mcmc_plot(seg1.g.a.b,
           prob_outer = 0.95)

plot(conditional_effects(seg1.g.a.b), points = F) 


# Changes the fixed effects (i.e. random variable) to odd's ratio 
exp(fixef(ms1.a.b)[,-2])


```

### greaters only additive 1-term (mtl)

```{r}

seg1.g.a.t <- brm(
  formula = bf(segment_width ~ 1 + log_mtl),
  data = dat.g%>%filter(segment_width <350),
  family = gaussian(),
  cores = 4,
  chains = 4,
  thin = 10, #chop out transitions?
  warmup = 10000, #half of iterations
  iter = 20000,
  prior = c(
      prior(student_t(3, 2.8, 2.5), "Intercept"),
      prior(cauchy(0,3), coef= "log_mtl")),
  #prior = priors,
  save_pars = save_pars(all = TRUE), #need this for loo comparison
  control = list(adapt_delta = 0.97, max_treedepth = 19), #adapt_delta the target average proposal acceptance probability during Stan's adaptation period
  set.seed(2020)
)

save(seg1.g.a.t, file=paste(getwd(), "/models/", "crane_trachea_segments_greater_additive_mtl_fam_gaussian_conservative.Rdata", sep="")) # save model

#load("crane_trachea_segments_greater_additive_sex_fam_poisson_conservative.Rdata") # If loading from pre-saved file and not re-running

seg1.g.a.t

# pp check
pp_check(seg1.g.a.t, ndraws = 100) 
pp_check(seg1.g.a.t, type = "stat", stat = 'median', ndraws = 2000)
pp_check(seg1.g.a.t, type = "stat", stat = 'mean', ndraws = 2000)

# trace and density plots
plot(seg1.g.a.t)

# pairwise plots
pairs(seg1.g.a.t)


# Quick plot of estimates and 95% CIs (default is 95% CI:
#mcmc_plot(m1.a.l)
mcmc_plot(seg1.g.a.t,
           prob_outer = 0.95)

plot(conditional_effects(seg1.g.a.t), points = F) 


# Changes the fixed effects (i.e. random variable) to odd's ratio 
exp(fixef(ms1.a.t)[,-2])


```

### greaters only additive 2-term (sex + bursa)

```{r}

seg2.g.a.sb <- brm(
  formula = bf(segment_width ~ 1 + sex + bursa),
  data = dat.g%>%filter(segment_width <350),
  family = gaussian(),
  cores = 4,
  chains = 4,
  thin = 10, #chop out transitions?
  warmup = 10000, #half of iterations
  iter = 20000,
  prior = c(
      prior(student_t(3, 2.8, 2.5), "Intercept")),
  #prior = priors,
  save_pars = save_pars(all = TRUE), #need this for loo comparison
  control = list(adapt_delta = 0.97, max_treedepth = 19), #adapt_delta the target average proposal acceptance probability during Stan's adaptation period
  set.seed(2020)
)

save(seg2.g.a.sb, file=paste(getwd(), "/models/", "crane_trachea_segments_greater_additive_bursa-sex_fam_gaussian_conservative.Rdata", sep="")) # save model

#load("crane_trachea_segments_greater_additive_bursa-sex_fam_poisson_conservative.Rdata") # If loading from pre-saved file and not re-running

seg2.g.a.sb

# pp check
pp_check(seg2.g.a.sb, ndraws = 100) 
pp_check(seg2.g.a.sb, type = "stat", stat = 'median', ndraws = 2000)
pp_check(seg2.g.a.sb, type = "stat", stat = 'mean', ndraws = 2000)

# trace and density plots
plot(seg2.g.a.sb)

# pairwise plots
pairs(seg2.g.a.sb)


# Quick plot of estimates and 95% CIs (default is 95% CI:
#mcmc_plot(m1.a.l)
mcmc_plot(seg2.g.a.sb,
           prob_outer = 0.95)

plot(conditional_effects(seg2.g.a.sb), points = F) 



# Changes the fixed effects (i.e. random variable) to odd's ratio 
exp(fixef(seg2.g.a.sb)[,-2])


```

### greaters only additive 2-term (sex + mtl)

```{r}

seg2.g.a.st <- brm(
  formula = bf(segment_width ~ 1 + sex + log_mtl),
  data = dat.g%>%filter(segment_width <350),
  family = gaussian(),
  cores = 4,
  chains = 4,
  thin = 10, #chop out transitions?
  warmup = 10000, #half of iterations
  iter = 20000,
  prior = c(
      prior(student_t(3, 2.8, 2.5), "Intercept"),
      prior(normal(0, 10), coef = "log_mtl")),
  #prior = priors,
  save_pars = save_pars(all = TRUE), #need this for loo comparison
  control = list(adapt_delta = 0.97, max_treedepth = 19), #adapt_delta the target average proposal acceptance probability during Stan's adaptation period
  set.seed(2020)
)

save(seg2.g.a.st, file=paste(getwd(), "/models/", "crane_trachea_segments_greater_additive_sex-mtl_fam_gaussian_conservative.Rdata", sep="")) # save model

#load("crane_trachea_segments_greater_additive_bursa-sex_fam_poisson_conservative.Rdata") # If loading from pre-saved file and not re-running

seg2.g.a.st

# pp check
pp_check(seg2.g.a.st, ndraws = 100) 
pp_check(seg2.g.a.st, type = "stat", stat = 'median', ndraws = 2000)
pp_check(seg2.g.a.st, type = "stat", stat = 'mean', ndraws = 2000)

# trace and density plots
plot(seg2.g.a.st)

# pairwise plots
pairs(seg2.g.a.st)


# Quick plot of estimates and 95% CIs (default is 95% CI:
#mcmc_plot(m1.a.l)
mcmc_plot(seg2.g.a.st,
           prob_outer = 0.95)

plot(conditional_effects(seg2.g.a.st), points = F) 


# Changes the fixed effects (i.e. random variable) to odd's ratio 
exp(fixef(seg2.g.a.st)[,-2])


```

### greaters only additive 2-term (bursa + mtl)

```{r}

seg2.g.a.bt <- brm(
  formula = bf(segment_width ~ 1 + bursa + log_mtl),
  data = dat.g%>%filter(segment_width <350),
  family = gaussian(),
  cores = 4,
  chains = 4,
  thin = 10, #chop out transitions?
  warmup = 10000, #half of iterations
  iter = 20000,
  prior = c(
      prior(student_t(3, 2.8, 2.5), "Intercept"),
      prior(normal(0, 10), coef = "log_mtl")),
  #prior = priors,
  save_pars = save_pars(all = TRUE), #need this for loo comparison
  control = list(adapt_delta = 0.97, max_treedepth = 19), #adapt_delta the target average proposal acceptance probability during Stan's adaptation period
  set.seed(2020)
)

save(seg2.g.a.bt, file=paste(getwd(), "/models/", "crane_trachea_segments_greater_additive_bursa-mtl_fam_gaussian_conservative.Rdata", sep="")) # save model

#load("crane_trachea_segments_greater_additive_bursa-sex_fam_poisson_conservative.Rdata") # If loading from pre-saved file and not re-running

# pp check
pp_check(seg2.g.a.bt, ndraws = 100) 
pp_check(seg2.g.a.bt, type = "stat", stat = 'median', ndraws = 2000)
pp_check(seg2.g.a.bt, type = "stat", stat = 'mean', ndraws = 2000)

# trace and density plots
plot(seg2.g.a.bt)

# pairwise plots
pairs(seg2.g.a.bt)


# Quick plot of estimates and 95% CIs (default is 95% CI:
#mcmc_plot(m1.a.l)
mcmc_plot(seg2.g.a.bt,
           prob_outer = 0.95)

plot(conditional_effects(seg2.g.a.bt), points = F) 


# Changes the fixed effects (i.e. random variable) to odd's ratio 
exp(fixef(seg2.g.a.bt)[,-2])


```

### greaters only three term additive (mtl + sex + bursa)

```{r}

seg3.g.a.tbs <- brm(
  formula = bf(segment_width ~ 1 + log_mtl + bursa + sex),
  data = dat.g%>%filter(segment_width <350),
  family = gaussian(),
  cores = 4,
  chains = 4,
  thin = 10, #chop out transitions?
  warmup = 10000, #half of iterations
  iter = 20000,
  prior = c(
      prior(student_t(3, 2.8, 2.5), "Intercept"),
     prior(normal(0, 10), coef="log_mtl")),
  #prior = priors,
  save_pars = save_pars(all = TRUE), #need this for loo comparison
  control = list(adapt_delta = 0.97, max_treedepth = 19), #adapt_delta the target average proposal acceptance probability during Stan's adaptation period
  set.seed(2020)
)

save(seg3.g.a.tbs, file=paste(getwd(), "/models/", "crane_trachea_segments_greater_additive_full_fam_gaussian_conservative.Rdata", sep="")) # save model

#load("crane_trachea_greater_additive_full_fam_gaussian_conservative.Rdata") # If loading from pre-saved file and not re-running

# pp check
pp_check(seg3.g.a.tbs, ndraws = 100) 
pp_check(seg3.g.a.tbs, type = "stat", stat = 'median', ndraws = 2000)
pp_check(seg3.g.a.tbs, type = "stat", stat = 'mean', ndraws = 2000)

# trace and density plots
plot(seg3.g.a.tbs)

# pairwise plots
pairs(seg3.g.a.tbs)


# Quick plot of estimates and 95% CIs (default is 95% CI:
#mcmc_plot(m1.a.l)
mcmc_plot(seg3.g.a.tbs,
           prob_outer = 0.95)

plot(conditional_effects(seg3.g.a.tbs), points = F) 


# Changes the fixed effects (i.e. random variable) to odd's ratio 
exp(fixef(seg3.g.a.tbs)[,-2])


```

### greaters only two term interaction (bursa + sex)

```{r}

seg2.g.i.sb <- brm(
  formula = bf(segment_width ~ 1 + (sex + bursa)^2),
  data = dat.g%>%filter(segment_width <350),
  family = gaussian(),
  cores = 4,
  chains = 4,
  thin = 10, #chop out transitions?
  warmup = 10000, #half of iterations
  iter = 20000,
  prior = c(
      prior(student_t(3, 2.8, 2.5), "Intercept")),
  #prior = priors,
  save_pars = save_pars(all = TRUE), #need this for loo comparison
  control = list(adapt_delta = 0.97, max_treedepth = 19), #adapt_delta the target average proposal acceptance probability during Stan's adaptation period
  set.seed(2020)
)

save(seg2.g.i.sb, file=paste(getwd(), "/models/", "crane_trachea_segments_greater_interaction_sex-bursa_fam_gaussian_conservative.Rdata", sep="")) # save model

#load("crane_trachea_greater_additive_full_fam_gaussian_conservative.Rdata") # If loading from pre-saved file and not re-running

# pp check
pp_check(seg2.g.i.sb, ndraws = 100) 
pp_check(seg2.g.i.sb, type = "stat", stat = 'median', ndraws = 2000)
pp_check(seg2.g.i.sb, type = "stat", stat = 'mean', ndraws = 2000)

# trace and density plots
plot(seg2.g.i.sb)

# pairwise plots
pairs(seg2.g.i.sb)


# Quick plot of estimates and 95% CIs (default is 95% CI:
#mcmc_plot(m1.a.l)
mcmc_plot(seg2.g.i.sb,
           prob_outer = 0.95)

plot(conditional_effects(seg2.g.i.sb), points = F) 



# Changes the fixed effects (i.e. random variable) to odd's ratio 
exp(fixef(seg2.g.i.sb)[,-2])


```

### greaters only two term interaction (mtl + sex)

```{r}

seg2.g.i.s.t <- brm(
  formula = bf(segment_width ~ 1 + (sex + log_mtl)^2),
  data = dat.g%>%filter(segment_width <350),
  family = gaussian(),
  cores = 4,
  chains = 4,
  thin = 10, #chop out transitions?
  warmup = 10000, #half of iterations
  iter = 20000,
  prior = c(
      prior(student_t(3, 2.8, 2.5), "Intercept"),
     prior(normal(0, 10), coef="log_mtl")),
  #prior = priors,
  save_pars = save_pars(all = TRUE), #need this for loo comparison
  control = list(adapt_delta = 0.97, max_treedepth = 19), #adapt_delta the target average proposal acceptance probability during Stan's adaptation period
  set.seed(2020)
)

save(seg2.g.i.s.t, file=paste(getwd(), "/models/", "crane_trachea_segments_greater_interaction_sex-mtl_fam_gaussian_conservative.Rdata", sep="")) # save model

#load("crane_trachea_greater_additive_full_fam_gaussian_conservative.Rdata") # If loading from pre-saved file and not re-running

# pp check
pp_check(seg2.g.i.s.t) 
pp_check(seg2.g.i.s.t, type = "stat", stat = 'median', ndraws = 2000)
pp_check(seg2.g.i.s.t, type = "stat", stat = 'mean', ndraws = 2000)

# trace and density plots
plot(seg2.g.i.s.t)

# pairwise plots
pairs(seg2.g.i.s.t)


# Quick plot of estimates and 95% CIs (default is 95% CI:
#mcmc_plot(m1.a.l)
mcmc_plot(seg2.g.i.s.t,
           prob_outer = 0.95)

plot(conditional_effects(seg2.g.i.s.t), points = F) 



# Changes the fixed effects (i.e. random variable) to odd's ratio 
exp(fixef(seg2.g.i.s.t)[,-2])


```

### Model selection

```{r}

# with sex only catagorical
LOO(seg.g.int.only, seg1.g.a.s, seg1.g.a.t, seg2.g.a.st, seg2.g.i.s.t, reloo=FALSE) 

 #Bayes R2
bayes_R2(seg.g.int.only) # 0.0000000000 nothing
bayes_R2(seg1.g.a.s) #0.07
bayes_R2(seg1.g.a.t) #0.19
bayes_R2(seg2.g.a.st) #0.07
bayes_R2(seg2.g.i.s.t) #0.14

#Since we are interested in segments by trachea length here is another model comparison set

LOO(seg.g.int.only, seg1.g.a.t, seg2.g.a.st, seg2.g.i.s.t, reloo=FALSE) 

 #Bayes R2
bayes_R2(seg.g.int.only) # 0.0000000000 nothing
bayes_R2(seg1.g.a.t) #0.014
bayes_R2(seg2.g.a.st) #0.14

```

### Predictions graph

Doing this for model with most explanatory power and since we are interested in sex differences and how segment number changes with trachea length

```{r}
g<-dat.g%>%filter(segment_count2 <350) %>%
  group_by(sex) %>%
   filter(sex %in% c("M", "F")) %>% 
   droplevels()%>%
  data_grid(log_mtl = seq_range(log_mtl, n = 100)) %>%
  add_epred_draws(seg2.g.i.s.t) %>%
  ggplot(aes(x = log_mtl, y = segment_count2, color = ordered(sex))) +
  stat_lineribbon(aes(y = .epred)) +
  geom_point(data = dat.g%>%filter(segment_count2 <350), alpha=0.3) +
  scale_fill_brewer(palette = "Greys") +
  scale_color_brewer(palette = "Set2")+
  labs( x=expression(log["10"]("mean trachea length (mm)")), y="segment count")+
   theme_classic(base_size = 14)+
  theme(legend.title = element_blank(),
        legend.position = "none")
g
ggsave(g, filename = paste(getwd(), "/figures/Epredictions_greaters_seg_mtl_conservative.pdf", sep=""), width=5, height = 5)
  
```

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
